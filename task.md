# タスクリスト

## 完了済み
- [x] NPB風143試合スケジュール（同リーグ25試合×5 + 交流戦3試合×6）
- [x] パワプロ風成績ページ（タイトル争い・打撃/投手テーブル・セイバー指標）
- [x] ダッシュボードのセパ分割順位表・GM視点シム操作パネル
- [x] 全ページUX改善（tabular-nums・ストライプ・ホバー・能力値色分け）
- [x] 打順・ローテーション設定（打順9枠、先発ローテ5-6人、クローザー/セットアッパー指定、CPU自動配置）
- [x] ロスター拡張（25人→65人、1軍/2軍制、昇格・降格UI、1軍28人制限）
- [x] クライマックスシリーズ + 日本シリーズ（CS 1st/Final + 日本シリーズ、アドバンテージ制）
- [x] 表彰式（MVP・首位打者・本塁打王・打点王・盗塁王・最多安打・最優秀防御率・最多勝・最高勝率・最多奪三振・最多セーブ・日本シリーズMVP）
- [x] 契約更改・加齢エンジン（年齢+1、契約年数-1、退団/更新、若手成長/ベテラン衰退）
- [x] ドラフトUI（候補一覧ソート/フィルタ、指名ボタン、CPU自動指名、指名履歴）
- [x] トレードUI（相手チーム選択、選手価値比較、CPU受諾判定）
- [x] 春季キャンプ（ポテンシャルベースの成長/衰退、キャンプレポート表示）
- [x] オフシーズンフロー（表彰→契約→ドラフト→完了のステップ進行）
- [x] 翌シーズン遷移（年間サイクルのループ完成）

## 選手起用・オーダー設定（残り）
- 野手起用法: 守備固め、代打、代走、途中交代
- 投手起用法: 勝利投手条件、スタミナ限界、中継ぎエース、敗戦処理、リード時、守護神

## 基本ステータスの見直し
- ミート、パワー、走力、肩力、守備力、捕球の基本ステータス（1~100刻み？）
- 守備位置、選球眼、潜在等は生かせるか？
- 投手は球速を150kmなどの実数表記にする
- 投手: 制球、変化球（パワプロ風に変化量を設定する。プロスピは球威と変化量で分かれているがどう扱うか検討）、スタミナ、精神、潜在
- 投手にも守備力が必要
- [x] 野手のステータスに弾道(1~4)を追加。打球の上がりやすさに関係する
- [x] 打順画面をフィールドUI+カード形式に改修（パワプロ風）
- [x] ローテ/リリーフタブを投手カード形式に改修（役割バッジ付き）
- [x] 選手総合値(Overall)をロスター・打順・ローテ画面に追加（プロスピ風数値+ランクレター）

## 外国人助っ人の追加
- 外国人枠の制限
- 助っ人選手の生成・獲得

## サブポジションの実装
- 複数ポジション対応
- ポジション適性の表示

## 特殊能力の実装
- どこまで行うか検討が必要
- パワプロ風の特殊能力？

## けが・大けがの実装
- 試合中の故障発生
- 離脱期間の設定

## FA・海外進出
- FA宣言・交渉
- 海外移籍（MLB等）

## 財務システム
- チーム強さ → ファン数増減 → シーズンオフ収入変動
- 選手年俸の設定・交渉
- どこまで複雑にするか検討が必要

## 練習設定
- 練習メニューの設定
- 選手成長への影響

---


## シミュレーション守備改修＋守備・投手指標の追加
現在のシミュレーションは守備がほぼ未実装。打球処理・守備位置の概念を入れて、守備指標と投手の打球系指標を追加する。

### Step 1: 打球処理の基盤整備（simulation.ts 改修） ✅ 完了
- [x] 打球に種類を持たせる（ゴロ / フライ / ライナー / ポップフライ）
- [x] 打者のパワー・ミートと投手の球種（シンカー系ボーナス）から打球種類の確率を決定
- [x] 守備位置に応じて処理する野手を重み付きランダムで決定
- [x] fielding / catching / arm を使ってアウト成功率・エラー率を計算
- [x] 盗塁の実装（走力 vs 捕手肩力）※前回実装済み
- [x] ダブルプレーの実装（1塁走者+2アウト未満+内野ゴロ時）
- [x] 死球 (HBP) の実装（制球力に連動）
- [x] 犠牲フライの実装（3塁走者+2アウト未満+フライアウト時）
- [x] 内野安打の実装（走力 vs 守備力）
- [x] フィルダースチョイスの実装（走者あり時5%）
- [x] 成績ページにPA/OBP/wOBA計算修正 + 死球/犠飛/併殺列追加

### Step 2: 守備成績の記録（モデル追加） ✅ 完了
- [x] 選手ごとに刺殺(PO)、補殺(A)、失策(E) を記録
- [x] PlayerGameStats に守備フィールドを追加
- [x] 守備率 = (PO+A) / (PO+A+E)
- [x] レンジファクター = (PO+A) / 試合数
- [x] 成績ページに守備タブ追加（PO/A/E/守備機会/守備率/RF表示）
- [x] errors累積バグ修正（season-advancement.ts）

### Step 3: 守備指標（UZR等） ✅ 完了
- [x] 簡易UZR: 守備位置の平均対比で守備貢献ランを算出
- [x] DRS (Defensive Runs Saved) も同様のアプローチで
- [x] 成績ページの守備タブにUZR列を追加（プラスマイナス色分け表示）

### Step 4: 投手の打球系指標 ✅ 完了
- [x] PitcherGameLog/PitcherSeasonStats に全打球タイプ記録（groundBalls/flyBalls/lineDrives/popups）
- [x] GB% (ゴロ率)、FB% (フライ率)、LD% (ライナー率)
- [x] GB/FB 比率
- [x] IFFB% (内野フライ率)
- [x] HR/FB (フライに対する本塁打率)
- [x] 成績ページの投手セイバー指標に追加

### Step 5: 打球物理エンジン ✅ 完了
- [x] 打球の方向(0-90°)・角度(-15~70°)・速度(80-185km/h)をガウス乱数で生成
- [x] batSide（左右打席）によるプル傾向の実装
- [x] フィールドゾーンベースの幾何学的フィールダー決定
- [x] バレルゾーン（高速+最適角度）による本塁打判定
- [x] 旧determineBattedBallType/assignFielder/resolveInPlayを置き換え
- [x] 単体テスト（batted-ball-physics.test.ts）追加

### Step 6: バランス調整 + 守備バグ修正 + 打球分析ツール ✅ 完了
- [x] バランス調整: バレル閾値150→158km/h、バレルHR率/フライHR率/ライナーHR率を下方修正、ライナー安打率0.68→0.62、フライ安打率0.14→0.12
- [x] 守備バグ修正: 1B自己処理ゴロの二重記録修正(3U)、外野中継プレーの外野手A記録追加、buildFielderMapにフルロスター補完で2B/CF/C消失修正
- [x] AtBatLog診断機能: simulateGameにoptions引数追加、collectAtBatLogs=trueで打球物理データ収集
- [x] 打球分析ツール: analytics/page.tsx新規作成（シーズンデータタブ+診断シミュレーションタブ、CSV出力対応）
- [x] テスト閾値調整: CF PO上限5→5.5

### Step 7: 守備機会分布のNPB準拠調整 ✅ 完了
- [x] NPB 2024守備データ調査・資料化（docs/fielding-distribution-analysis.md）
- [x] 外野ゾーン調整: LF<33°, CF<52°, RF≥52°（ノイズσ=4→7°に拡大）
- [x] 内野ゾーン調整: 2Bゾーン拡大(55→58°), 投手返し条件拡大(25-65°, <120km/h, 20%)
- [x] フォースアウト率: 95%→40%に削減（SS PO過多の解消）
- [x] 外野中継補殺率: flyout 20%→3%, lineout 18%→3%, sacfly 25%→5%
- [x] ライナー振り分け: exitVelocity>140||launchAngle>14 → >145||>16
- [x] 捕手関与プレー追加（groundout時5%でC:A記録）
- [x] テスト閾値を新分布に合わせて更新
- 主要改善: CF PO 5.05→3.14, 1B PO 6.56→8.07, RF PO 1.04→2.01, OF A 0.81→0.12

### Step 8: 打球分析ページ大幅強化 ✅ 完了
- [x] AtBatLogスリム化: batterName/pitcherNameを削除（IDのみで逆引き、約300KB節約）
- [x] シーズン試合でAtBatLog収集: 自チーム試合のみcollectAtBatLogs=trueを渡す（ポストシーズン含む）
- [x] 日本語化: 結果（ヒット/ゴロアウト等）・打球タイプ（ゴロ/フライ等）・守備位置（投/捕/一等）
- [x] 結果の色分け: HR=赤太字、三塁打=オレンジ太、二塁打=オレンジ、安打=黄、四球=青、併殺=暗灰等
- [x] ホームランの守備位置を「-」に修正
- [x] シーズンデータタブに打席詳細ログ追加（自チーム試合のみ記録の旨を表示）
- [x] 打球タイプ分布にアウトカムフィルタ（全体/ヒット/アウト）追加
- [x] 選手フィルタ追加（チーム絞込と連動、能力値カード表示）
- [x] 診断タブも同様に日本語化・色分け・HR修正・CSV日本語化を適用
- [x] 共通AtBatLogTableコンポーネントで両タブのログ表示を統一

## フィールド図の見た目改善（保留）
- 現在は自前SVGでグラデーション・フェンス・芝刈りパターン等を描画しているが、まだ見栄えが微妙
- フリーSVG素材サイト（FreeSVG.org, SVG Repo等）はBot対策で自動ダウンロード不可だった
- react-baseball-field-component (npm) は2018年製でReact 19非対応のため見送り
- 今後の方向性: 手動でフリーSVG素材をダウンロードして取り込む、またはCanvasベースの描画に切り替え、あるいはデザイナーに依頼

## 球種のビジュアル表示（保留）
- 現在はテーブル内テキスト表示（球種名+変化量）で仮実装
- パワプロ風のグラフィカル表示を検討したが、テーブルセル内に収まるサイズでは見づらかった
  - ブロック/セグメント式（5方向矢印）→ テーブル行が巨大化して一覧性が悪い
  - ラジアルドットチャート（test.jsx）→ コンパクトにすると文字が潰れて見づらい
- test.jsx にラジアルチャートの参考実装あり。選手詳細画面など広いスペースで使えるかも
- 今後の方向性: 選手個別詳細ページを作ったときにそこで使う、またはホバー/クリックポップアップで別途検討

## PMからの提案
<!-- PMが実装中に気づいた課題・改善点をここに追記する -->
<!-- 人間が確認して正式タスクに昇格させるか、却下する -->

### プレーアニメーション強化
現在のアニメーションは基本的な「ボール飛行→守備移動→走者進塁」の線形補間。以下の改善が考えられる:
- 走者の複数塁進塁（2塁打で1塁→3塁など）を塁間ごとのベースパスに沿って移動（現在は直線補間）
- 併殺打の中継プレー表現（SS→2B→1Bの送球ライン）
- ゴロの地面バウンド表現（サイドビューで地を這う動き）
- 守備全員のカバーリング（実際の野球のように関係ない野手も動く）
- インプレー終了後のリプレイ機能
- 実装データ: AtBatLogに既にbasesBeforePlay/outsBeforePlay/fielderPositionがあるため、追加データ不要で相当な表現が可能

### 指標追加候補
1point02.jpの指標サイトを調査した結果、以下が追加候補:
- **パークファクター**: ホーム/アウェイ別の得点比較。球場の概念追加が前提
- **WPA (Win Probability Added)**: 各打席での勝利確率変動。勝利確率エンジンが必要で工数大
- **DRS改良版**: 肩力・併殺関連を統合したDefensive Runs Saved
- **得点期待値テーブル**: 塁状況×アウト数の24パターンの期待得点（シーズンデータから集計可能）

### HR率のバランス検証
飛距離ベースHR判定に変更したため、HR率がNPB平均と比較して妥当か検証が必要。
診断シミュレーション10試合でチームHR/試合が1.0-1.5本程度に収まるか確認。
外れた場合はdragFactor(0.87)やフェンス際境界幅(0.95-1.05)を調整。

