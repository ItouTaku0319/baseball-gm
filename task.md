# タスクリスト

## 運用ルール

### スプリント制（2-3日サイクル）
- スプリント開始時: `/sprint plan` で計画、GMが承認
- スプリント中: 計画したタスクだけやる。アイデアはバックログに1行追加のみ
- スプリント終了時: `/sprint done` で振り返り → 次スプリント計画

### 自律実行の判断基準
PMは以下の条件を**すべて**満たすタスクを自律的に実行してよい:
1. `自律: YES` と明記されている
2. 完了条件が明確に定義されている
3. 品質ゲート（build通過、バランステスト等）がある

### 品質ゲート
すべての実装タスクは以下を通過すること:
- `npm run build` 成功
- シミュレーション変更時: `npx tsx scripts/test-balance-full.ts --games=1000` の全指標正常
- 型変更時: 既存セーブデータとの互換性を確認

### 委譲ルール
- `engine/` → impl-engine (sonnet)
- `app/` `components/` → impl-ui (sonnet)
- `models/` `store/` `db/` → impl-data (sonnet)
- 小規模・横断 → implementer (sonnet)
- 大きい変更後 → guardian で監査

---

## 現在のスプリント

### Sprint 2 (2/27-3/1): 守備AI品質改善ロードマップ

ロードマップ詳細: `docs/fielding-ai-roadmap.md`

| # | タスク | 担当 | 状態 | 自律 | 完了条件 |
|---|--------|------|------|------|---------|
| S2-1 | シミュレーション速度改善(P0: GC圧力削減) | impl-engine | 未着手 | YES | 1000試合テストの実行時間を計測し改善前比で高速化 |
| S2-2 | シミュレーション速度改善(P1: 再計算排除) | impl-engine | 未着手 | YES | calcPathInterceptキャッシュ、投球ループ最適化 |
| S2-3 | シミュレーション速度改善(P2: 計算量削減) | impl-engine | 未着手 | YES | vec2距離二乗比較、知覚間引き |
| S2-4 | 打球分布検証テスト作成 | impl-engine | 未着手 | YES | GB%/FB%/LD%/PU%・方向分布の自動検証テスト |
| S2-5 | 構造修正: 投手守備機会 | impl-engine | 未着手 | YES | P TC/G >= 1.0 (現状0.13) |
| S2-6 | 構造修正: ライナーアウト率 | impl-engine | 未着手 | YES | ライナーアウト率50-70%、R9テストskip解除 |
| S2-7 | ゴールデンテスト作成(30-50件) | PM | 未着手 | NO | 代表的打球パターンの期待結果を定義、全ケース通過 |
| S2-8 | ゾーン幅調整 + 統合テスト | impl-engine | 未着手 | YES | SS TC/G < 5.0、全ポジションTC/GがNPBの70-130%範囲内 |

### Sprint 2 の方針
- Phase 1(速度改善) → Phase 2(入力検証) → Phase 3(構造修正) → Phase 4(統合) の順序で進行
- S2-1〜S2-3は依存なし、順次実行
- S2-4はS2-1完了後に着手（高速化した環境でテスト）
- S2-5〜S2-6はS2-4の結果を見て着手（入力が正しいことを確認してから）
- S2-7はPMが設計、S2-8はS2-5〜S2-7完了後
- 1000試合テストは最終検証に使う（キャリブレーションには使わない）

### 前スプリントの結果
- Sprint 1 (2/26-2/28): エージェント型守備AI実装完了、本番切替完了、ThrowPlayチェーン導入完了
- NPB準拠の統計調整で堂々巡り → レイヤー分離アプローチに切り替え

---

## バックログ（優先度順）

### エンジン改善（試合シミュレーション）

#### BL-001: ワイルドピッチ/パスボール
- 優先度: HIGH
- 自律: YES
- コスト: 低
- 概要: 投手control/捕手catchingベースの確率判定。走者全員1塁進塁
- 完了条件: AtBatResult追加、advanceRunners対応、バランステスト通過

#### BL-002: 盗塁成功率の調整
- 優先度: HIGH
- 自律: YES
- コスト: 低
- 概要: 現行の試行率が低すぎる（30-40%→NPB準拠70%）。数値調整のみ
- 完了条件: バランステストでSB関連指標がNPB範囲内

#### BL-003: エラー率のスキル依存化
- 優先度: MEDIUM
- 自律: YES
- コスト: 低
- 概要: fielding能力30と90でエラー率が同じ問題。確率をスキル依存に
- 完了条件: グリッドテスト通過、バランステスト通過

#### BL-004: ボーク実装
- 優先度: MEDIUM
- 自律: YES
- コスト: 低
- 概要: ランナーあり時に低確率で発生。走者全員1塁進塁
- 完了条件: AtBatResult追加、バランステスト通過

#### BL-005: 捕手送球時間の分化
- 優先度: MEDIUM
- 自律: YES
- コスト: 低
- 概要: 2塁送球 vs 3塁送球の時間差。投手のクイック考慮
- 完了条件: 盗塁成功率がポジション別でNPB準拠

#### BL-006: 牽制球
- 優先度: MEDIUM
- 自律: NO（設計判断が必要）
- コスト: 中
- 概要: 投手の牽制→ランナーの帰塁判定。盗塁との駆け引き

#### BL-007: ファウルフライアウト + ファウルチップ三振
- 優先度: HIGH
- 自律: YES（打球生成設計完了後）
- コスト: 中
- 依存: 打球生成ロジック再設計の完了
- 概要: 打球方向拡張後、ファウルゾーンのフライ捕球とチップ三振を追加

### UI改善

#### BL-010: シーズン進行UIの拡張
- 優先度: MEDIUM
- 自律: NO（UX判断が必要）
- 概要: 1日/1カード/1週間 + トグル(交流戦まで/AS前まで/シーズン終了まで) + カスタム試合数

#### BL-011: 選手詳細ページ
- 優先度: LOW
- 自律: NO
- 概要: 能力・成績・キャリア推移・打球分析を1画面に集約

#### BL-012: プレーアニメーション強化
- 優先度: LOW
- 自律: NO
- 概要: 走者塁間移動、併殺中継、ゴロバウンド等

### ゲームデザイン（要設計判断）

#### BL-020: 外国人助っ人
- 優先度: MEDIUM
- 自律: NO
- 未決定: 外国人枠ルール、獲得方法、能力傾向

#### BL-021: 特殊能力
- 優先度: MEDIUM
- 自律: NO
- 未決定: 実装する能力の選定、影響度、UI表示

#### BL-022: 基本ステータスの見直し
- 優先度: LOW
- 自律: NO
- 未決定: 能力値の刻み、変化球の表現方法

#### BL-023: FA・海外移籍
- 優先度: LOW
- 自律: NO
- 未決定: FA権条件、補償制度、海外移籍の扱い

#### BL-024: 財務システム
- 優先度: LOW
- 自律: NO
- 未決定: 収入源の粒度、年俸交渉の仕組み

#### BL-025: 練習設定
- 優先度: LOW
- 自律: NO
- 未決定: メニュー種類、春季キャンプとの整合性

---

## 保留

### フィールド図の見た目改善
- 状態: 保留（素材入手の問題）

### 球種のビジュアル表示
- 状態: 保留（選手詳細ページ実装時に再検討）

### 天候・球場特性
- 状態: 保留（コスト高、他に優先度の高いものが多い）

---

## 完了済み

<details>
<summary>完了済みタスク一覧（クリックで展開）</summary>

- [x] NPB風143試合スケジュール（同リーグ25試合×5 + 交流戦3試合×6）
- [x] パワプロ風成績ページ（タイトル争い・打撃/投手テーブル・セイバー指標）
- [x] ダッシュボードのセパ分割順位表・GM視点シム操作パネル
- [x] 全ページUX改善（tabular-nums・ストライプ・ホバー・能力値色分け）
- [x] 打順・ローテーション設定
- [x] ロスター拡張（25人→65人、1軍/2軍制）
- [x] クライマックスシリーズ + 日本シリーズ
- [x] 表彰式
- [x] 契約更改・加齢エンジン
- [x] ドラフトUI
- [x] トレードUI
- [x] 春季キャンプ
- [x] オフシーズンフロー
- [x] 翌シーズン遷移
- [x] 投手起用法（スタミナ消費・交代AI・セーブ/ホールド）
- [x] 投手起用方針の個別設定
- [x] 弾道(1-4)追加
- [x] 打順画面フィールドUI改修
- [x] ローテ/リリーフ投手カード形式改修
- [x] 選手総合値(Overall)追加
- [x] シミュレーション守備改修 Step 1-9 全完了
- [x] 投球分析画面
- [x] dragFactor定数の一元化
- [x] GAME-008: リリーフ連投制限
- [x] GAME-003: GAME_SPEC.md陳腐化修正
- [x] GAME-007: 精神力をシミュレーション活用
- [x] GAME-001: 野手途中交代
- [x] GAME-004: 得点期待値テーブル
- [x] GAME-002: バント処理
- [x] GAME-006: サブポジション対応
- [x] GAME-005: けが・故障システム
- [x] キャッチャー/投手の近距離フライ捕球改善 (de987e0)
- [x] 守備グリッドテスト(Vitest)作成 (de987e0)

</details>
