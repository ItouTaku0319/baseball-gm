# タスクリスト

## 運用ルール

### 自律実行の判断基準
PMは以下の条件を**すべて**満たすタスクを自律的に実行してよい:
1. `自律: YES` と明記されている
2. 完了条件が明確に定義されている
3. 品質ゲート（build通過、バランステスト等）がある

`自律: NO` のタスクは人間の判断を待つ。要件が曖昧なものをPMが勝手に解釈して進めない。

### タスク選定の優先順位
1. 優先度 HIGH のタスクから着手
2. 同優先度なら依存関係の少ないものから
3. 1セッション2-3タスクが上限（コンテキスト精度の維持）

### 品質ゲート
すべての実装タスクは以下を通過すること:
- `npm run build` 成功
- シミュレーション変更時: `npx tsx scripts/test-balance-full.ts --games=1000` の全指標正常
- 型変更時: 既存セーブデータとの互換性を確認（マイグレーション実装）

---

## 自律実行可能タスク

（現在すべて完了済み）

### GAME-006: サブポジション対応
- 優先度: MEDIUM
- 自律: YES
- 依存: なし
- 対象ファイル: `models/player.ts`, `engine/player-generator.ts`, `app/game/[id]/roster/page.tsx`, `engine/simulation.ts`
- 現状: Player型にpositionフィールド（プライマリのみ）。subPositions関連なし。simulation.tsのbuildFielderMap()は打順から1対1でポジション割り当て
- 実装ポイント:
  - Player型に `subPositions?: Position[]` を追加（最大2つ）
  - 選手生成時に近接ポジションを付与（ポジション隣接マップを定義）
  - `buildFielderMap()`で打順のpositionとsubPositionsの両方を考慮
  - 守備力補正: サブポジション時は `fielding * 0.80` を適用
- ポジション隣接マップ:
  ```
  C → 1B
  1B → 3B, C
  2B → SS, 3B
  3B → 1B, 2B, SS
  SS → 2B, 3B
  LF → CF, RF
  CF → LF, RF
  RF → LF, CF
  P → なし
  ```
- 完了条件:
  - [ ] Player型にsubPositions?: Position[]を追加（最大2つ）
  - [ ] 選手生成時にメインポジションの隣接ポジションを30%の確率で1つ、10%で2つ付与
  - [ ] サブポジション時の守備力はメインの80%
  - [ ] ロスターページにサブポジション表示（メインの横に小さく表記）
  - [ ] 打順設定でサブポジションへの配置を許可
  - [ ] 既存セーブデータとの互換性（`?? []` でデフォルト）
  - [ ] `npm run build` 成功

---

## 人間判断待ちタスク

### 基本ステータスの見直し（残り）
- 自律: NO（ゲームデザイン判断が必要）
- 未決定事項:
  - 能力値の刻み（1-100の連続値 vs 5刻み vs パワプロ風アルファベット）
  - 投手の変化球をパワプロ風の変化量にするか、プロスピ風の球威+変化量にするか
  - 投手の守備力をどう扱うか（専用パラメータ vs 野手と共通）

### 外国人助っ人の追加
- 自律: NO（ゲームルール設計が必要）
- 未決定事項:
  - 外国人枠のルール（NPB準拠で投手3/野手3？一軍4人制限？）
  - 助っ人の獲得方法（オフシーズン自動？FA市場？スカウト？）
  - 能力値の傾向（パワー/球速高め、守備/精神低めのステレオタイプにするか）

### 特殊能力の実装
- 自律: NO（設計範囲が広すぎる）
- 未決定事項:
  - どの特殊能力を実装するか（チャンス○/×、対左○/×、ピンチ○/×...）
  - シミュレーションへの影響度（微調整 vs 大きく変わる）
  - UIでの表示方法

### FA・海外進出
- 自律: NO（ゲーム経済に大きく影響）
- 未決定事項:
  - FA権の取得条件（NPB準拠: 8年 or 独自ルール）
  - FA選手の獲得コスト（補償選手制度を入れるか）
  - 海外移籍の扱い（引退と同等？数年後に復帰？）

### 財務システム
- 自律: NO（ゲームの根幹設計に関わる）
- 未決定事項:
  - 収入源（チケット、グッズ、放映権...どこまで細かく？）
  - 年俸交渉の仕組み（自動 vs 手動）
  - 赤字時のペナルティ

### 練習設定
- 自律: NO（成長システムの再設計が必要）
- 未決定事項:
  - 練習メニューの種類と効果
  - 既存の春季キャンプ成長との整合性
  - シーズン中の練習効果

---

## 完了済み

<details>
<summary>完了済みタスク一覧（クリックで展開）</summary>

- [x] NPB風143試合スケジュール（同リーグ25試合×5 + 交流戦3試合×6）
- [x] パワプロ風成績ページ（タイトル争い・打撃/投手テーブル・セイバー指標）
- [x] ダッシュボードのセパ分割順位表・GM視点シム操作パネル
- [x] 全ページUX改善（tabular-nums・ストライプ・ホバー・能力値色分け）
- [x] 打順・ローテーション設定
- [x] ロスター拡張（25人→65人、1軍/2軍制）
- [x] クライマックスシリーズ + 日本シリーズ
- [x] 表彰式
- [x] 契約更改・加齢エンジン
- [x] ドラフトUI
- [x] トレードUI
- [x] 春季キャンプ
- [x] オフシーズンフロー
- [x] 翌シーズン遷移
- [x] 投手起用法（スタミナ消費・交代AI・セーブ/ホールド）
- [x] 投手起用方針の個別設定
- [x] 弾道(1-4)追加
- [x] 打順画面フィールドUI改修
- [x] ローテ/リリーフ投手カード形式改修
- [x] 選手総合値(Overall)追加
- [x] シミュレーション守備改修 Step 1-9 全完了
- [x] 投球分析画面
- [x] dragFactor定数の一元化
- [x] GAME-008: リリーフ連投制限（4連投以上→登板不可、日次更新、GAME_SPEC追記、バランス検証済み / 790d254）
- [x] GAME-003: GAME_SPEC.md陳腐化修正（能力値・未実装機能・弾道・Overall・守備AI / fb84902）
- [x] GAME-007: 精神力をシミュレーション活用（ピンチ制球±5、疲労軽減30% / a3f3c28）
- [x] GAME-001: 野手途中交代（代打8回~/代走7回~/守備固め8回~ / eaa89e0）
- [x] GAME-004: 得点期待値テーブル（24パターン・ヒートマップ表示 / 2e0e648）
- [x] GAME-002: バント処理（犠牲バント・セーフティバント・投手守備機会増加 / 5304790）
- [x] GAME-006: サブポジション対応（隣接ポジション付与・守備力80%補正・UI表示 / 0d6e182）
- [x] GAME-005: けが・故障システム（試合中故障発生・日次回復・ダッシュボード表示 / 7440296）

</details>

---

## 保留

### フィールド図の見た目改善
- 状態: 保留（素材入手の問題）
- 自前SVGで描画中。フリー素材サイトはBot対策で自動DL不可。手動でのSVG素材取り込みか、デザイナー依頼を検討。

### 球種のビジュアル表示
- 状態: 保留（表示スペースの問題）
- テーブルセル内では見づらい。選手詳細ページを作ったときに再検討。

---

## PMからの提案
<!-- PMが実装中に気づいた課題・改善点をここに追記する -->
<!-- 人間が確認して正式タスクに昇格させるか、却下する -->

### プレーアニメーション強化
現在のアニメーションは基本的な「ボール飛行→守備移動→走者進塁」の線形補間。以下の改善が考えられる:
- 走者の複数塁進塁を塁間ごとのベースパスに沿って移動
- 併殺打の中継プレー表現
- ゴロの地面バウンド表現
- 守備全員のカバーリング
- インプレー終了後のリプレイ機能
- 実装データ: AtBatLogに既にbasesBeforePlay/outsBeforePlay/fielderPositionがあり追加データ不要

### 指標追加候補
- **パークファクター**: 球場の概念追加が前提
- **WPA**: 勝利確率エンジンが必要で工数大
- **DRS改良版**: 肩力・併殺関連を統合
- **得点期待値テーブル**: → GAME-004 として正式タスク化済み

### 打球軌道ポップアップに守備側選手情報を表示
- 守備位置に選手アイコン+名前を表示
- 守備力・肩力・捕球の能力値をツールチップ表示
- 送球アニメーション
- 前提データ: AtBatLogのfielderPositionで取得可能

### 選手詳細ページの新規作成
- 現状: 選手の能力・成績は各ページに分散（ロスター、成績、打球分析、投球分析）
- 提案: 選手個別の詳細ページを作成し、能力値・シーズン成績・キャリア推移・打球分析・投球分析を1画面に集約
- 球種ビジュアル表示（保留中）もここで解決できる可能性あり
- ルート: `/game/[id]/player/[playerId]`
