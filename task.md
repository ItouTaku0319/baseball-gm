# タスクリスト

## 運用ルール

### 自律実行の判断基準
PMは以下の条件を**すべて**満たすタスクを自律的に実行してよい:
1. `自律: YES` と明記されている
2. 完了条件が明確に定義されている
3. 品質ゲート（build通過、バランステスト等）がある

`自律: NO` のタスクは人間の判断を待つ。要件が曖昧なものをPMが勝手に解釈して進めない。

### タスク選定の優先順位
1. 優先度 HIGH のタスクから着手
2. 同優先度なら依存関係の少ないものから
3. 1セッション2-3タスクが上限（コンテキスト精度の維持）

### 品質ゲート
すべての実装タスクは以下を通過すること:
- `npm run build` 成功
- シミュレーション変更時: `npx tsx scripts/test-balance-full.ts --games=1000` の全指標正常
- 型変更時: 既存セーブデータとの互換性を確認（マイグレーション実装）

---

## 自律実行可能タスク

### GAME-001: 野手途中交代（代打・代走・守備固め）
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`, `models/team.ts`
- 実装ポイント:
  - `simulateHalfInning()` 内の打順ループに代打判定を挿入
  - `simulateGame()` 内のイニング間ループに守備固め判定を挿入
  - 走者の代走は打席結果確定後、次の打席開始前に判定
  - `TeamGameState` に `usedBatterIds: Set<string>` を追加（再出場防止）
  - ベンチ選手は `team.roster` から `lineupBatterIds` と `usedBatterIds` を除外して取得
  - 新規関数: `selectPinchHitter()`, `selectPinchRunner()`, `selectDefensiveReplacement()`
- 完了条件:
  - [ ] 代打: 打席開始前にベンチ野手との交代AIロジック
    - 条件: 8-9回、ビハインド時、現打者のcontact+power合計が低い場合
    - 代打後の選手はその守備位置を引き継ぐ
  - [ ] 代走: 出塁後に走力の高いベンチ選手と交代
    - 条件: 7回以降、僅差（±3点以内）、走力差20以上
  - [ ] 守備固め: イニング間にリード時の終盤で守備力の高い控え選手と交代
    - 条件: 8-9回、リード時、fielding差15以上
  - [ ] 交代後の選手はその試合に再出場不可
  - [ ] playerStatsに途中交代の選手も正しく記録される（出場試合数、打席数等）
  - [ ] `npm run build` 成功
  - [ ] 1000試合バランステスト全指標正常

### GAME-002: バント処理の実装
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`, `engine/fielding-ai.ts`
- 現状: バント関連の型定義・コード一切なし。AtBatResult型に"sacrifice_bunt"等の追加が必要
- 実装ポイント:
  - `simulateAtBat()` 内の確率チェーン（死球→四球→三振→インプレー）の前にバント判定を挿入
  - バント打球はfielding-ai.tsで処理: 方向10-70°、速度30-60km/h、角度-5~5°のゴロとして生成
  - AtBatResult型に `"sacrifice_bunt"` | `"bunt_hit"` | `"bunt_out"` を追加
  - PO/A/E記録: バント処理は主に投手(P)・捕手(C)・一塁手(1B)・三塁手(3B)が関与
  - BatterSeasonStats / PitcherSeasonStats に sacrificeBunts を追加
- 完了条件:
  - [ ] 犠牲バント判定: 走者1塁or2塁 + 0-1アウト + 打者がバント適性（投手 or contact<50の下位打線）
    - 成功率: `0.60 + contact * 0.002`（contact50で70%、100で80%）
    - 失敗時: ファウル(30%)→アウトカウントなし追加判定 / 三振(20%) / フィルダースチョイス(10%)
  - [ ] セーフティバント: speed≥80の打者が低確率(3-5%)で試行
    - 成功率: `0.20 + speed * 0.002 + contact * 0.001`
  - [ ] 投手の守備機会（PO/A）がバント処理で増加すること
  - [ ] 1000試合で犠打数がチームあたり30-60/シーズン（NPB準拠）
  - [ ] `npm run build` 成功
  - [ ] 1000試合バランステスト全指標正常
  - [ ] GAME_SPEC.mdにバント判定フローを追記

### GAME-003: GAME_SPEC.md の陳腐化修正
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `GAME_SPEC.md`
- 現状の問題（コード調査済み）:
  - 「守備力: 現在シミュレーション未使用」→ fielding-ai.tsで到達速度・捕球率に使用中
  - 「スタミナ: 現在シミュレーション未使用（完投固定）」→ STAMINA_PER_PITCH=0.7で消費、50%以下で疲労ペナルティ
  - 「精神力: 現在シミュレーション未使用」→ **実際に未使用のまま**（simulation.ts行63,82,840で取得するが計算に不使用）
  - 「先発が完投（リリーフ未実装）」→ 完全実装済み
  - 「打順設定: 手動設定不可」→ 打順UIで手動設定可能
  - 「盗塁: statsに項目あるがシミュレーション未使用」→ 実装済み
  - 「セーブ: savePitcherId常にnull」→ セーブ/ホールド判定実装済み
- 完了条件:
  - [ ] 上記すべての陳腐化記述を実コードに合わせて更新
  - [ ] 精神力は「未使用」のまま正直に記載（GAME-007で活用予定と注記）
  - [ ] 投手起用方針セクション追加（先発6種・リリーフ5種・maxInnings）
  - [ ] 弾道(trajectory)セクション追加
  - [ ] 選手総合値(Overall)の計算式セクション追加
  - [ ] 守備AIセクションの記述をfielding-ai.tsの実装に合わせて更新
  - [ ] 「未実装機能」セクションを現状に合わせて整理

### GAME-004: 得点期待値テーブルの実装
- 優先度: MEDIUM
- 自律: YES
- 依存: なし
- 対象ファイル: `app/game/[id]/analytics/page.tsx`（表示のみ、エンジン変更なし）
- 実装ポイント:
  - AtBatLogの `basesBeforePlay`(boolean[3]) + `outsBeforePlay`(0-2) で24状況を分類
  - そのイニングの残り得点を「その打席以降のそのイニングの得点」として集計
  - 集計はクライアントサイドでatBatLogsをループして計算（新規エンジン関数不要）
  - analytics/page.tsx の新タブ or 既存タブ内のセクションとして表示
- 完了条件:
  - [ ] 塁状況(8パターン) × アウト数(3パターン) = 24パターンの期待得点を集計
  - [ ] analytics/page.tsx にヒートマップ or テーブル形式で表示
  - [ ] 各セルにサンプル数(N)を表示（信頼度の目安）
  - [ ] NPBの一般的な期待値と概ね一致（無走者0アウト≈0.4-0.5、満塁0アウト≈2.0-2.5）
  - [ ] `npm run build` 成功

### GAME-005: けが・故障システム
- 優先度: MEDIUM
- 自律: YES
- 依存: GAME-001（途中交代の仕組みが前提）
- 対象ファイル: `models/player.ts`, `engine/simulation.ts`, `engine/season-advancement.ts`, `store/game-store.ts`, `app/game/[id]/page.tsx`
- 現状: Player型にinjury関連フィールドなし。season-advancement.tsの`simulateDay()`末尾が日次回復処理の挿入ポイント
- 実装ポイント:
  - Player型に `injury?: { type: 'minor'|'moderate'|'severe'; daysRemaining: number; description: string }` を追加
  - 試合中の故障: `simulateAtBat()`内でインプレー時に低確率で発生判定
  - 日次回復: `season-advancement.ts`の`simulateDay()`戻り値直前に`recoverInjuredPlayers()`を挿入
  - 故障選手の自動2軍降格: `rosterLevels[playerId] = 'ni_gun'` に自動変更
  - ダッシュボード: 故障者リスト（選手名・故障内容・残り日数）をカード表示
- 完了条件:
  - [ ] 試合中に低確率（全打席の0.1-0.2%）で故障発生
  - [ ] 故障レベル: 軽傷（7-14日）/ 中傷（30-60日）/ 重傷（残りシーズン全休）
    - 発生比率: 軽傷70% / 中傷25% / 重傷5%
  - [ ] 故障中の選手は試合出場不可（打順・ローテから自動除外）
  - [ ] 日次進行で`daysRemaining`を減算、0になったら故障解除
  - [ ] ダッシュボードに故障者リスト表示
  - [ ] 既存セーブデータとの互換性（`injury`フィールドはoptionalなので `?? undefined` で互換）
  - [ ] `npm run build` 成功
  - [ ] 143試合シーズンでチームあたり5-15件程度の故障が発生すること

### GAME-006: サブポジション対応
- 優先度: MEDIUM
- 自律: YES
- 依存: なし
- 対象ファイル: `models/player.ts`, `engine/player-generator.ts`, `app/game/[id]/roster/page.tsx`, `engine/simulation.ts`
- 現状: Player型にpositionフィールド（プライマリのみ）。subPositions関連なし。simulation.tsのbuildFielderMap()は打順から1対1でポジション割り当て
- 実装ポイント:
  - Player型に `subPositions?: Position[]` を追加（最大2つ）
  - 選手生成時に近接ポジションを付与（ポジション隣接マップを定義）
  - `buildFielderMap()`で打順のpositionとsubPositionsの両方を考慮
  - 守備力補正: サブポジション時は `fielding * 0.80` を適用
- ポジション隣接マップ:
  ```
  C → 1B
  1B → 3B, C
  2B → SS, 3B
  3B → 1B, 2B, SS
  SS → 2B, 3B
  LF → CF, RF
  CF → LF, RF
  RF → LF, CF
  P → なし
  ```
- 完了条件:
  - [ ] Player型にsubPositions?: Position[]を追加（最大2つ）
  - [ ] 選手生成時にメインポジションの隣接ポジションを30%の確率で1つ、10%で2つ付与
  - [ ] サブポジション時の守備力はメインの80%
  - [ ] ロスターページにサブポジション表示（メインの横に小さく表記）
  - [ ] 打順設定でサブポジションへの配置を許可
  - [ ] 既存セーブデータとの互換性（`?? []` でデフォルト）
  - [ ] `npm run build` 成功

### GAME-007: 精神力(mentalToughness)のシミュレーション活用
- 優先度: LOW
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`
- 現状: `getEffectivePitcherAbilities()`で取得されるが、一切計算に使われていない（行63,82,840）
- 実装ポイント:
  - `getEffectivePitcherAbilities()`の戻り値は既にmentalToughnessを含む
  - 活用案（どれか1-2個に絞る）:
    - **ピンチ時の制球安定**: 得点圏走者あり時に `control += mentalToughness * 0.1`
    - **リード/ビハインド時の安定**: 点差が大きいとパフォーマンス変動（精神力高→安定、低→不安定）
    - **疲労耐性**: スタミナ50%以下時の疲労ペナルティを精神力で軽減
- 完了条件:
  - [ ] mentalToughnessがシミュレーション結果に影響する計算式を最低1つ実装
  - [ ] 影響は微調整レベル（±5%以内）に抑える（ゲームバランス破壊防止）
  - [ ] GAME_SPEC.mdに精神力の効果を記載
  - [ ] `npm run build` 成功
  - [ ] 1000試合バランステスト全指標正常（精神力の影響で大きくブレないこと）

### GAME-008: リリーフ投手の連投制限
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`, `models/team.ts`, `engine/season-advancement.ts`
- 現状: **未コミットの実装が既に存在**（simulation.ts, team.ts, lineup.tsに差分あり）
  - `TeamLineupConfig`に`pitcherAppearances?: Record<string, number>`追加済み
  - `selectNextPitcher()`に連投制限フィルター`isAvailableByFatigue()`追加済み
  - 3連投以上→登板不可、2連投→behind_ok/mop_upは登板不可
  - lineup.tsのmaxInnings調整(close_game:2→1, behind_ok/mop_up:3→2)
- 完了条件:
  - [ ] 未コミット変更の動作確認とコミット
  - [ ] season-advancement.tsで`pitcherAppearances`の日次更新（登板日+1、非登板日リセット）が正しく動作
  - [ ] 1000試合バランステストで完投以外の試合でリリーフが適切にローテーションすること
  - [ ] GAME_SPEC.mdに連投制限ルールを追記
  - [ ] `npm run build` 成功

---

## 人間判断待ちタスク

### 基本ステータスの見直し（残り）
- 自律: NO（ゲームデザイン判断が必要）
- 未決定事項:
  - 能力値の刻み（1-100の連続値 vs 5刻み vs パワプロ風アルファベット）
  - 投手の変化球をパワプロ風の変化量にするか、プロスピ風の球威+変化量にするか
  - 投手の守備力をどう扱うか（専用パラメータ vs 野手と共通）

### 外国人助っ人の追加
- 自律: NO（ゲームルール設計が必要）
- 未決定事項:
  - 外国人枠のルール（NPB準拠で投手3/野手3？一軍4人制限？）
  - 助っ人の獲得方法（オフシーズン自動？FA市場？スカウト？）
  - 能力値の傾向（パワー/球速高め、守備/精神低めのステレオタイプにするか）

### 特殊能力の実装
- 自律: NO（設計範囲が広すぎる）
- 未決定事項:
  - どの特殊能力を実装するか（チャンス○/×、対左○/×、ピンチ○/×...）
  - シミュレーションへの影響度（微調整 vs 大きく変わる）
  - UIでの表示方法

### FA・海外進出
- 自律: NO（ゲーム経済に大きく影響）
- 未決定事項:
  - FA権の取得条件（NPB準拠: 8年 or 独自ルール）
  - FA選手の獲得コスト（補償選手制度を入れるか）
  - 海外移籍の扱い（引退と同等？数年後に復帰？）

### 財務システム
- 自律: NO（ゲームの根幹設計に関わる）
- 未決定事項:
  - 収入源（チケット、グッズ、放映権...どこまで細かく？）
  - 年俸交渉の仕組み（自動 vs 手動）
  - 赤字時のペナルティ

### 練習設定
- 自律: NO（成長システムの再設計が必要）
- 未決定事項:
  - 練習メニューの種類と効果
  - 既存の春季キャンプ成長との整合性
  - シーズン中の練習効果

---

## 完了済み

<details>
<summary>完了済みタスク一覧（クリックで展開）</summary>

- [x] NPB風143試合スケジュール（同リーグ25試合×5 + 交流戦3試合×6）
- [x] パワプロ風成績ページ（タイトル争い・打撃/投手テーブル・セイバー指標）
- [x] ダッシュボードのセパ分割順位表・GM視点シム操作パネル
- [x] 全ページUX改善（tabular-nums・ストライプ・ホバー・能力値色分け）
- [x] 打順・ローテーション設定
- [x] ロスター拡張（25人→65人、1軍/2軍制）
- [x] クライマックスシリーズ + 日本シリーズ
- [x] 表彰式
- [x] 契約更改・加齢エンジン
- [x] ドラフトUI
- [x] トレードUI
- [x] 春季キャンプ
- [x] オフシーズンフロー
- [x] 翌シーズン遷移
- [x] 投手起用法（スタミナ消費・交代AI・セーブ/ホールド）
- [x] 投手起用方針の個別設定
- [x] 弾道(1-4)追加
- [x] 打順画面フィールドUI改修
- [x] ローテ/リリーフ投手カード形式改修
- [x] 選手総合値(Overall)追加
- [x] シミュレーション守備改修 Step 1-9 全完了
- [x] 投球分析画面
- [x] dragFactor定数の一元化

</details>

---

## 保留

### フィールド図の見た目改善
- 状態: 保留（素材入手の問題）
- 自前SVGで描画中。フリー素材サイトはBot対策で自動DL不可。手動でのSVG素材取り込みか、デザイナー依頼を検討。

### 球種のビジュアル表示
- 状態: 保留（表示スペースの問題）
- テーブルセル内では見づらい。選手詳細ページを作ったときに再検討。

---

## PMからの提案
<!-- PMが実装中に気づいた課題・改善点をここに追記する -->
<!-- 人間が確認して正式タスクに昇格させるか、却下する -->

### プレーアニメーション強化
現在のアニメーションは基本的な「ボール飛行→守備移動→走者進塁」の線形補間。以下の改善が考えられる:
- 走者の複数塁進塁を塁間ごとのベースパスに沿って移動
- 併殺打の中継プレー表現
- ゴロの地面バウンド表現
- 守備全員のカバーリング
- インプレー終了後のリプレイ機能
- 実装データ: AtBatLogに既にbasesBeforePlay/outsBeforePlay/fielderPositionがあり追加データ不要

### 指標追加候補
- **パークファクター**: 球場の概念追加が前提
- **WPA**: 勝利確率エンジンが必要で工数大
- **DRS改良版**: 肩力・併殺関連を統合
- **得点期待値テーブル**: → GAME-004 として正式タスク化済み

### 打球軌道ポップアップに守備側選手情報を表示
- 守備位置に選手アイコン+名前を表示
- 守備力・肩力・捕球の能力値をツールチップ表示
- 送球アニメーション
- 前提データ: AtBatLogのfielderPositionで取得可能

### 選手詳細ページの新規作成
- 現状: 選手の能力・成績は各ページに分散（ロスター、成績、打球分析、投球分析）
- 提案: 選手個別の詳細ページを作成し、能力値・シーズン成績・キャリア推移・打球分析・投球分析を1画面に集約
- 球種ビジュアル表示（保留中）もここで解決できる可能性あり
- ルート: `/game/[id]/player/[playerId]`
