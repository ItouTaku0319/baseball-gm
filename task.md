# タスクリスト

## 運用ルール

### 自律実行の判断基準
PMは以下の条件を**すべて**満たすタスクを自律的に実行してよい:
1. `自律: YES` と明記されている
2. 完了条件が明確に定義されている
3. 品質ゲート（build通過、バランステスト等）がある

`自律: NO` のタスクは人間の判断を待つ。要件が曖昧なものをPMが勝手に解釈して進めない。

### タスク選定の優先順位
1. 優先度 HIGH のタスクから着手
2. 同優先度なら依存関係の少ないものから
3. 1セッション2-3タスクが上限（コンテキスト精度の維持）

### 品質ゲート
すべての実装タスクは以下を通過すること:
- `npm run build` 成功
- シミュレーション変更時: `npx tsx scripts/test-balance-full.ts --games=1000` の全指標正常
- 型変更時: 既存セーブデータとの互換性を確認（マイグレーション実装）

---

## 自律実行可能タスク

### GAME-001: 野手途中交代（代打・代走・守備固め）
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`, `models/player.ts`, `models/team.ts`, `store/game-store.ts`
- 完了条件:
  - [ ] 代打: イニング間にベンチ野手と打順を入れ替えるAIロジック
    - 条件: 8-9回、ビハインド時、打力の低い投手打席などで発動
    - 代打後の選手は守備位置を引き継ぐか、さらに守備固めが入る
  - [ ] 代走: 得点圏に走力の低い走者がいる場合、走力の高いベンチ選手と交代
    - 条件: 7回以降、僅差、走力差20以上
  - [ ] 守備固め: リード時の終盤に守備力の高い控え選手と交代
    - 条件: 8-9回、リード時、守備力差15以上
  - [ ] 交代後の選手はその試合に再出場不可
  - [ ] playerStatsに途中交代の選手も正しく記録される
  - [ ] `npm run build` 成功
  - [ ] 1000試合バランステスト全指標正常

### GAME-002: バント処理の実装
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`, `engine/fielding-ai.ts`
- 完了条件:
  - [ ] 犠牲バント: 走者1塁or2塁 + 0-1アウト + 投手or下位打線で発動
    - 成功率: ミート依存で60-80%
    - 失敗時: 三振/ファウル/フィルダースチョイス
  - [ ] セーフティバント: 走力80以上 + 内野守備位置が深い場合に低確率で発動
    - 成功率: 走力とミート依存で20-40%
  - [ ] 投手の守備機会（バント処理）が増加すること
  - [ ] PO/A/E が正しく記録される
  - [ ] `npm run build` 成功
  - [ ] 1000試合バランステスト全指標正常
  - [ ] バント関連の統計がGAME_SPEC.mdに追記される

### GAME-003: GAME_SPEC.md の陳腐化修正
- 優先度: HIGH
- 自律: YES
- 依存: なし
- 対象ファイル: `GAME_SPEC.md`
- 完了条件:
  - [ ] 「守備力: 現在シミュレーション未使用」→ 守備AIでの使用を反映
  - [ ] 「スタミナ: 現在シミュレーション未使用」→ 投手スタミナ消費を反映
  - [ ] 「精神力: 現在シミュレーション未使用」→ 現在の使用状況を確認して更新
  - [ ] 「先発が完投（リリーフ未実装）」→ 投手交代AIの実装を反映
  - [ ] 「打順設定: 手動設定不可」→ 打順UI実装を反映
  - [ ] 「未実装機能」セクションの内容を現状に合わせて更新
  - [ ] 投手起用方針セクションを追加
  - [ ] 弾道・Overall等の新機能を反映

### GAME-004: 得点期待値テーブルの実装
- 優先度: MEDIUM
- 自律: YES
- 依存: なし
- 対象ファイル: `engine/simulation.ts`（集計）, `app/game/[id]/analytics/page.tsx`（表示）
- 完了条件:
  - [ ] 塁状況(8パターン) × アウト数(3パターン) = 24パターンの期待得点を集計
  - [ ] シーズンのatBatLogsから算出（basesBeforePlay + outsBeforePlay を使用）
  - [ ] analytics/page.tsx にヒートマップ形式で表示
  - [ ] NPBの一般的な期待値（無走者0アウト≈0.45, 満塁0アウト≈2.2 etc.）と大きく乖離しない
  - [ ] `npm run build` 成功

### GAME-005: けが・故障システム
- 優先度: MEDIUM
- 自律: YES
- 依存: GAME-001（途中交代の仕組みが前提）
- 対象ファイル: `engine/simulation.ts`, `models/player.ts`, `store/game-store.ts`
- 完了条件:
  - [ ] 試合中に低確率（1試合あたり0.5-1%）で故障発生
  - [ ] 故障レベル: 軽傷（1-2週間）/ 中傷（1-2ヶ月）/ 重傷（シーズン全休）
  - [ ] 故障中の選手は出場不可、自動で2軍に降格
  - [ ] 故障からの復帰（離脱日数経過で自動復帰 or 手動昇格）
  - [ ] Player型に injuryStatus / injuryDaysRemaining を追加
  - [ ] ダッシュボードに故障者リスト表示
  - [ ] 既存セーブデータとの互換性（マイグレーション）
  - [ ] `npm run build` 成功

### GAME-006: サブポジション対応
- 優先度: MEDIUM
- 自律: YES
- 依存: なし
- 対象ファイル: `models/player.ts`, `engine/player-generator.ts`, `app/game/[id]/roster/page.tsx`
- 完了条件:
  - [ ] Player型にsubPositions: Position[]を追加（最大2つ）
  - [ ] 選手生成時にメインポジションの近接ポジションを20-40%の確率で付与
    - 例: SS → 2B/3B、CF → LF/RF、C → 1B
  - [ ] サブポジション時の守備力はメインの70-90%
  - [ ] ロスターページにサブポジション表示
  - [ ] 打順設定でサブポジションへの配置を許可
  - [ ] 既存セーブデータとの互換性（`?? []` でデフォルト）
  - [ ] `npm run build` 成功

---

## 人間判断待ちタスク

### 基本ステータスの見直し（残り）
- 自律: NO（ゲームデザイン判断が必要）
- 未決定事項:
  - 能力値の刻み（1-100の連続値 vs 5刻み vs パワプロ風アルファベット）
  - 投手の変化球をパワプロ風の変化量にするか、プロスピ風の球威+変化量にするか
  - 投手の守備力をどう扱うか（専用パラメータ vs 野手と共通）

### 外国人助っ人の追加
- 自律: NO（ゲームルール設計が必要）
- 未決定事項:
  - 外国人枠のルール（NPB準拠で投手3/野手3？一軍4人制限？）
  - 助っ人の獲得方法（オフシーズン自動？FA市場？スカウト？）
  - 能力値の傾向（パワー/球速高め、守備/精神低めのステレオタイプにするか）

### 特殊能力の実装
- 自律: NO（設計範囲が広すぎる）
- 未決定事項:
  - どの特殊能力を実装するか（チャンス○/×、対左○/×、ピンチ○/×...）
  - シミュレーションへの影響度（微調整 vs 大きく変わる）
  - UIでの表示方法

### FA・海外進出
- 自律: NO（ゲーム経済に大きく影響）
- 未決定事項:
  - FA権の取得条件（NPB準拠: 8年 or 独自ルール）
  - FA選手の獲得コスト（補償選手制度を入れるか）
  - 海外移籍の扱い（引退と同等？数年後に復帰？）

### 財務システム
- 自律: NO（ゲームの根幹設計に関わる）
- 未決定事項:
  - 収入源（チケット、グッズ、放映権...どこまで細かく？）
  - 年俸交渉の仕組み（自動 vs 手動）
  - 赤字時のペナルティ

### 練習設定
- 自律: NO（成長システムの再設計が必要）
- 未決定事項:
  - 練習メニューの種類と効果
  - 既存の春季キャンプ成長との整合性
  - シーズン中の練習効果

---

## 完了済み

<details>
<summary>完了済みタスク一覧（クリックで展開）</summary>

- [x] NPB風143試合スケジュール（同リーグ25試合×5 + 交流戦3試合×6）
- [x] パワプロ風成績ページ（タイトル争い・打撃/投手テーブル・セイバー指標）
- [x] ダッシュボードのセパ分割順位表・GM視点シム操作パネル
- [x] 全ページUX改善（tabular-nums・ストライプ・ホバー・能力値色分け）
- [x] 打順・ローテーション設定
- [x] ロスター拡張（25人→65人、1軍/2軍制）
- [x] クライマックスシリーズ + 日本シリーズ
- [x] 表彰式
- [x] 契約更改・加齢エンジン
- [x] ドラフトUI
- [x] トレードUI
- [x] 春季キャンプ
- [x] オフシーズンフロー
- [x] 翌シーズン遷移
- [x] 投手起用法（スタミナ消費・交代AI・セーブ/ホールド）
- [x] 投手起用方針の個別設定
- [x] 弾道(1-4)追加
- [x] 打順画面フィールドUI改修
- [x] ローテ/リリーフ投手カード形式改修
- [x] 選手総合値(Overall)追加
- [x] シミュレーション守備改修 Step 1-9 全完了
- [x] 投球分析画面
- [x] dragFactor定数の一元化

</details>

---

## 保留

### フィールド図の見た目改善
- 状態: 保留（素材入手の問題）
- 自前SVGで描画中。フリー素材サイトはBot対策で自動DL不可。手動でのSVG素材取り込みか、デザイナー依頼を検討。

### 球種のビジュアル表示
- 状態: 保留（表示スペースの問題）
- テーブルセル内では見づらい。選手詳細ページを作ったときに再検討。

---

## PMからの提案
<!-- PMが実装中に気づいた課題・改善点をここに追記する -->
<!-- 人間が確認して正式タスクに昇格させるか、却下する -->

### プレーアニメーション強化
現在のアニメーションは基本的な「ボール飛行→守備移動→走者進塁」の線形補間。以下の改善が考えられる:
- 走者の複数塁進塁を塁間ごとのベースパスに沿って移動
- 併殺打の中継プレー表現
- ゴロの地面バウンド表現
- 守備全員のカバーリング
- インプレー終了後のリプレイ機能
- 実装データ: AtBatLogに既にbasesBeforePlay/outsBeforePlay/fielderPositionがあり追加データ不要

### 指標追加候補
- **パークファクター**: 球場の概念追加が前提
- **WPA**: 勝利確率エンジンが必要で工数大
- **DRS改良版**: 肩力・併殺関連を統合
- **得点期待値テーブル**: → GAME-004 として正式タスク化済み

### 打球軌道ポップアップに守備側選手情報を表示
- 守備位置に選手アイコン+名前を表示
- 守備力・肩力・捕球の能力値をツールチップ表示
- 送球アニメーション
- 前提データ: AtBatLogのfielderPositionで取得可能
