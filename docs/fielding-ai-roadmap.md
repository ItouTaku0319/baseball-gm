# 守備AI ロードマップ

## 背景
4日間パラメータ調整の堂々巡りに陥った。根本原因は「複雑な系のアウトプットだけを見てチューニングしている」こと。
レイヤーを分離して下から積み上げるアプローチに切り替える。

## Phase 1: 速度改善
速度が遅いと検証サイクルが回らない。先に速度を上げる。

### 1-1. P0: GC圧力削減（オブジェクト再利用）
- [ ] `updatePerception()`: perceivedLandingをミュータブル更新に変更
- [ ] `getPositionAt()`: 引数にVec2書き込み先を受け取る or 内部バッファ再利用
- [ ] `resolveCallOffs()`: filter()の毎ティック新配列生成を排除
- [ ] `checkGroundBallIntercept()`: filter+sortの3回分をキャッシュ

### 1-2. P1: 不要な再計算の排除
- [ ] `calcPathIntercept()`: ゴロ経路定数(方向・最大距離・停止時間)を打球生成時にキャッシュ
- [ ] `getEffectivePitcherAbilities()`: 毎投球→打席開始時に1回だけ
- [ ] バランステスト: `collectAtBatLogs` をOFF可能に

### 1-3. P2: 計算量削減
- [ ] `vec2Distance()`の比較用途を距離二乗比較に置換（sqrtを省略）
- [ ] `calcPathIntercept()`: ステップサイズ動的化（遠距離は粗く）
- [ ] 知覚更新の間引き: confidence高→2-3ティックに1回

### 速度改善の計測
- 改善前後で1000試合テストの実行時間を計測
- 目標: 2-3倍高速化

## Phase 2: 入力検証（打球分布）
守備AIの入力が間違っていたら出力も間違う。先に入力を検証する。

### 2-1. 打球分布テスト作成
- [ ] `generateBattedBall()` を5000回呼んで分布を検証するテスト
- 検証項目:
  - GB%: 43-47% (NPB ~45%)
  - FB%: 28-32% (NPB ~30%)
  - LD%: 18-22% (NPB ~20%)
  - PU%: 4-6%  (NPB ~5%)
  - 方向分布: 0-30° / 30-60° / 60-90° の偏り確認
  - 打球速度分布: ポジション別の着弾分布

### 2-2. 方向偏りの確認と修正
- LF PO過多(NPBの189%)が打球方向偏りに起因するか特定
- 必要に応じてgenerateBattedBall()の方向生成ロジックを修正

## Phase 3: 構造修正
パラメータ調整ではなくロジック変更が必要なもの。

### 3-1. 投手守備機会の構造的改善
- 現状: P TC = 0.13 (NPB: 1.87) → 7%しかない
- 対策案:
  - 投手の反応時間改善（投球後ペナルティ見直し）
  - マウンド付近(方向30-60°, 距離5-18m)のゴロで投手に優先権
  - バント頻度の見直し

### 3-2. ライナーアウト率の改善
- 現状: ~36% (目標: 60-70%)、R9テストがskip
- 対策:
  - reaction倍率 2.5 → 1.5 に緩和
  - catchReach * 0.40 制限の見直し（0.60-0.70程度に）

### 3-3. ゴールデンテスト作成（30-50件）
- 代表的な打球パターンの「期待結果」を人間が定義
- 1ケースずつデバッグ可能
- テスト例:
  - SS正面ゴロ → 6-3アウト
  - 2B正面ゴロ → 4-3アウト
  - CF定位置フライ → CF捕球
  - 投手返しゴロ → P→1Bアウト
  - ライナー → 適切な野手が捕球

## Phase 4: ゾーン調整 + 統合テスト
構造が安定した上での微調整。

### 4-1. ゾーン幅調整
- SS: 22-52° → 25-48° (幅30°→23°)
- 2B: 48-75° → 44-72° (幅27°→28°)
- ゴールデンテストを維持しつつTC/Gを改善

### 4-2. 1000試合テストで最終検証
- ポジション別TC/Gの品質ゲートを自動テストに組み込む
- リグレッションテストとして使う（キャリブレーションツールではない）

## 実データ活用について
- 現段階では不要
- 将来的にゴールデンテストの正解値をデータで裏付けるために活用する可能性あり
- 「AIを学習させる」のではなく「テストの正解を定義する」ために使う
