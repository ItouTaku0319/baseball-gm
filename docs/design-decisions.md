# 設計メモ（Design Decisions）

PMが実装中に行った設計判断の記録。次のセッションのClaudeが「なぜこうなっているか」を理解するためのリファレンス。
関連機能を修正する際に参照する。

## 試合シミュレーション

- **打球処理エンジン**: 打席結果を「死球→四球→三振→インプレー」の確率チェーンで判定。インプレー時は打球タイプ（ゴロ/フライ/ライナー/ポップ）を決定し、タイプごとの重み付きランダムで守備位置を割り当て、該当野手の守備能力(fielding/catching/arm)で結果を判定する。投手はpitching側の守備能力を使用。
- **シンカー系ゴロ率ボーナス**: sinker/shootの球種レベルに応じてゴロ率を最大+7%。パワーの高い打者はフライ率が上がりゴロ率が下がる。
- **併殺打(GIDP)**: 1塁走者あり+2アウト未満+ゴロ時に判定。`0.12 + (1-speed/100)*0.06`。走力が低い打者ほど併殺率が高い。
- **得点(runs)記録**: advanceRunnersの戻り値に`scoredRunners: Player[]`を追加。全生還走者のrunsを正しく記録。

## 打球物理

- **打球物理エンジン**: インプレー時に打球の方向(0-90°)・角度(-15~70°)・速度(80-185km/h)をガウス乱数で生成。打球方向はbatSide（左右打席）によるプル傾向あり。
- **飛距離ベースHR判定**: 放物運動+空気抵抗補正で推定飛距離を計算し、NPB標準フェンス距離(両翼100m, 中堅122m)との比較で判定。ratio≥1.05でHR確定、0.95-1.05でフェンス際ランダム、<0.95はHR不可。
- **フェンス高さHR判定(v9)**: `FENCE_HEIGHT(4.0m)`追加。フェンス水平距離到達時の打球高さ≥FENCE_HEIGHTが必要。急角度キャリー減衰: 35°以下=フルキャリー、35-50°=線形減衰、50°以上=キャリー無し。
- **飛距離計算統一(v8)**: `estimateDistance()`と`calcBallLanding()`の不一致を修正。`physics-constants.ts`で全物理定数を一元管理。
- **弾道(trajectory)**: BatterAbilitiesに弾道(1-4)を追加。`angleMean += (trajectory-2)*3`で打球角度に影響。HR判定時にキャリーファクター[1.07,1.19,1.25,1.30]で飛距離を補正。

## 守備

- **守備AI (fielding-ai.ts)**: 2Dフィールド座標系で9野手の到達時間を物理計算。ゴロは「捕球→送球→走者との競争」、フライ/ライナーは「着地前に到達→捕球試行」。長打はバウンスペナルティモデルで回収時間を計算し、送球時間vs走者の進塁時間で自然に決まる。
- **守備成績(PO/A/E)**: 三振→捕手PO、ゴロアウト→処理野手A+1BにPO、フライ系→処理野手PO、併殺→処理野手A+中継パターンに応じたPO×2、盗塁死→捕手A+該当塁野手PO。
- **簡易UZR/DRS**: `rangeRuns = ((PO+A)/Gの差) * 0.8 * G`、`errorRuns = (E/Gの差) * 0.7 * G`。
- **守備機会分布調整**: NPB 2024実データ基準。外野ゾーン: LF<33°, CF<52°, RF≥52°。フォースアウト率40%。投手返し条件(25-65°, <120km/h, 20%)。詳細は `docs/fielding-distribution-analysis.md` 参照。

## 指標・計算式

- **セイバーメトリクス**: wOBAリニアウェイト（BB=0.69, 1B=0.87, 2B=1.27, 3B=1.62, HR=2.10）はMLB 2023年基準値。
- **FIP定数**: `cFIP = lgERA - (13*lgHR + 3*lgBB - 2*lgK) / lgIP` でリーグ実績から動的算出。
- **ERA+/OPS+**: ERA+=(lgERA/ERA)*100、OPS+=(OBP/lgOBP+SLG/lgSLG-1)*100。
- **選手総合値(Overall)**: 野手=`contact*2.2+power*2.2+speed*1.5+eye*1.5+fielding*1.2+arm*0.8+catching*0.6`、投手=`velNorm*2.0+control*2.5+stamina*1.5+mental*1.0+pitchBonus*3.0`。1-999スケール。
- **投手打球系指標**: GB%/FB%/LD%は全打球(BIP)に対する割合。IFFB%=popup/(flyBalls+popups)。HR/FB=HR/flyBalls。

## バランス調整履歴

| バージョン | 主な変更 | 検証結果 |
|---|---|---|
| v2→v3 | 飛距離ベースHR判定に完全移行 | - |
| v4 | LD率35→22%、K%15→20%、ゴロ安打経路追加 | - |
| v5→v6 | dragFactor 0.87→0.70 | 打率.255, HR/試合2.7, R/試合7.0 |
| v7 | パワー速度係数0.5→0.15、弾道キャリーファクター導入 | 弾道別HR%: 1=1.4%, 2=3.8%, 3=6.2%, 4=9.0% |
| v8 | 飛距離計算統一、CARRY_FACTORS引き上げ | AVG.262, HR/試合1.94, BABIP.307 |
| v9 | carryFactor適用+フェンス高さ判定 | HR/試合2.37, HR/FB%15.6% |

## 投手システム

- **スタミナ消費**: `STAMINA_PER_PITCH=0.7`/球。疲労ペナルティ: スタミナ50%以下から線形低下(MAX velocity-12.5%, control-25%, pitchLevel-12.5%)。
- **投手交代AI**: イニング間: `shouldChangePitcher()`でstarterUsagePolicyに応じた判定。イニング途中: 3失点+2アウト未満、満塁+0アウト+スタミナ30%以下、スタミナ10%以下。
- **投手起用方針**: 投手個別の`pitcherUsages: Record<string, PitcherUsageConfig>`。先発6種、リリーフ5種。maxInnings制限（デフォルト全リリーフ1）。
- **連投制限**: `pitcherAppearances`で連投日数を追跡、4連投以上は登板不可。同役割内で連投日数が少ない投手を優先。
- **投球分析**: 各打席の「決め球」1球をselectPitch+generatePitchLocationで逆算生成。collectAtBatLogs=true時のみ。

## UI

- **スケジュール生成**: ラウンドロビン+Latin Square法。
- **打球軌道可視化**: SVGベースで2ビュー（フィールド俯瞰+サイド横）。フライアウトはバウンドなし。フェンス直撃は跳ね返り表現あり。
- **打球分析ページ**: AtBatLogからbatterName/pitcherNameを削除しIDのみで逆引き（ストレージ節約）。自チーム試合のみログ収集。
- **打順画面**: フィールド図(SVG)+打順カードリストの2カラム。選択ベースのswap操作。
- **成績ソート**: SortThに昇順/降順トグル。ERA/FIP/xFIP/失策はデフォルト昇順。
