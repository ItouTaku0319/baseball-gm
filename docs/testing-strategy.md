# テスト戦略

Baseball GMプロジェクト全体のテスト方針。新しいセッションでも参照できるよう、テストの種類・使い分け・運用ルールをまとめる。

---

## テストピラミッド（このプロジェクト版）

```
            Layer 4: バランステスト（1000試合統計・NPB準拠）
           ─────────────────────────────────────────────
          Layer 3: グリッドテスト（網羅的パターン・統計ゲート）
         ─────────────────────────────────────────────────
        Layer 2: サニティチェック（明らかなバグ検出・ルールベース）
       ─────────────────────────────────────────────────────
      Layer 1: 単体テスト（個別関数の正しさ・決定的）
```

**重要な原則**: 上のレイヤーは下のレイヤーが通ってから意味を持つ。Layer 2を飛ばすと「平均は正常だけど個別がおかしい」が漏れる。

---

## Layer 1: 単体テスト

**目的**: 個別の関数が正しい入出力を返すことを保証する。

**対象**: `engine/` 内の純粋関数（計算関数・変換関数）。

**書き方**:
- 乱数を固定して決定的にする（`options.random = () => 0.5` 等）
- 境界値とエッジケースを必ず含める
- 期待値と実際値の両方を失敗メッセージに含める

**例**:
```typescript
it("calcBallLanding: 方向45°・角度30°・初速120km/hで期待着地距離に収まる", () => {
  const result = calcBallLanding({ direction: 45, launchAngle: 30, exitVelocity: 120 });
  expect(result.distance).toBeGreaterThan(expectedMin);
  expect(result.distance).toBeLessThan(expectedMax);
});
```

**ツール**: Vitest（`npm run test`）

**いつ書く**:
- 新しい関数を作った時
- バグ修正時（再発防止のため）

---

## Layer 2: サニティチェック（結合テスト）

**目的**: 複数の関数を組み合わせた時に「明らかにおかしい」結果が出ないことを保証する。

**対象**: 関数の組み合わせ、シナリオベース。

**書き方**: 「〇〇なら△△であるべき」というルールを直接テストコードに記述する。

**例**:
```typescript
it("目の前のフライ（距離3m以内・滞空1.5秒以上）は必ず捕球される", () => {
  const violations = allRows.filter(r =>
    r.nearestFielderDist < 3 && r.flightTime > 1.5 && r.result !== "out"
  );
  expect(violations.length).toBe(0);
});

it("ゴロで三塁打は発生しない", () => {
  const violations = allRows.filter(r =>
    r.ballType === "ground_ball" && r.result === "triple"
  );
  expect(violations.length).toBe(0);
});
```

**守備AIサニティルール一覧**: `docs/fielding-test-guide.md` の「Layer 2」セクションを参照。

**いつ書く**:
- バグ報告があった時（再発防止パターンとして追加）
- 新しいゲームルールを追加した時

---

## Layer 3: グリッドテスト（統合テスト）

**目的**: 入力空間を網羅的にカバーし、回帰テストとして機能させる。

**対象**: システム全体の入出力（守備AIの打球処理等）。

**書き方**: パラメータ空間をグリッド分割して全パターン実行し、統計ゲートを通過するかを検証する。

**守備AIグリッド（現行 5,586パターン）**:
```
方向:     0, 5, 10, ... 90°   (19値)
初速:     40, 50, 60, ... 170 km/h (14値)
打球角度: -15, -12, -9, ... 45°  (21値)
→ 19 × 14 × 21 = 5,586パターン
```

**現行ゲート**:
| ゲート | 基準 |
|--------|------|
| 0-15mフライアウト率 | >= 80% |
| 15-30mフライアウト率 | >= 30% |
| 遠距離P/C回収件数 | = 0件 |
| 浅ゴロOF回収件数 | = 0件 |
| 深打球IF回収件数 | = 0件 |
| ゴロ方向別アウト率 | >= 50% |

**テスト時の注意**:
- `noiseScale=0` で実行（知覚ノイズありだと同じパターンで結果が変わる）
- 乱数固定（`() => 0.5`）でダイビングキャッチ等の乱数を固定

**いつ書く/更新する**:
- システムの大きな変更後にゲートを見直す
- 新しい守備処理パターンを追加した時はゲートを追加

---

## Layer 4: バランステスト（E2Eテスト）

**目的**: ゲーム全体の統計がNPB準拠であることを保証する。

**対象**: 試合シミュレーション全体。

**実行方法**:
```bash
npx tsx scripts/test-balance-full.ts --games=1000
```

**NPB準拠ゲート**:
| 指標 | 下限 | 上限 | NPB参考 |
|------|------|------|---------|
| チーム打率 | .240 | .280 | .255前後 |
| HR/試合（両チーム合計） | 1.0 | 1.5 | 1.1 |
| K% | 15% | 25% | 20% |
| BB% | 7% | 12% | 9% |
| BABIP | .280 | .320 | .300 |
| GO/AO | 0.8 | 1.3 | 1.0 |

**いつ実行する**:
- シミュレーションロジックを変更した時は必ず実行
- 新規ゲートの追加は必要に応じて（闇雲に増やさない）

---

## テストの書き方ルール

- **テストファイルの配置**: `src/engine/__tests__/` にVitest形式で配置
- **命名規則**: `{対象}-{レイヤー}.test.ts`（例: `fielding-grid.test.ts`, `batted-ball-physics.test.ts`）
- **乱数の固定**: 単体テストでは乱数を固定する（`options.random = () => 0.5` 等）
- **テストの独立性**: 各テストケースは他のテストケースに依存しない
- **失敗メッセージ**: 期待値と実際値の両方を表示する。グリッドテストでは違反パターン先頭5件を `console.log` で出力
- **スクリプト版**: 長時間かかるテストは `scripts/` にスタンドアロンスクリプトとして配置

---

## いつどのテストを走らせるか

| タイミング | 走らせるテスト |
|---|---|
| 関数を書いた/修正した | Layer 1（対象の単体テスト） |
| 機能を追加した | Layer 1 + Layer 2（サニティチェック） |
| シミュレーション変更 | Layer 1〜4 全部 |
| コミット前 | `npm run build` + `npm run test` |
| 大きな変更後 | `npx tsx scripts/test-balance-full.ts --games=1000` |

---

## テスト追加のチェックリスト

新しい機能を実装したら:
1. [ ] Layer 1: 核となる関数の単体テストを書いたか
2. [ ] Layer 2: 「明らかにおかしい」パターンのサニティチェックを追加したか
3. [ ] Layer 3: グリッドテストのゲートを更新する必要があるか
4. [ ] Layer 4: バランステストを実行して数値が範囲内か

---

## 既存テスト一覧

| ファイル | レイヤー | 内容 |
|---|---|---|
| `src/engine/__tests__/fielding-grid.test.ts` | L3 | 5,586パターンの守備AIグリッドテスト（ゲート6項目） |
| `src/engine/__tests__/fielding-distribution.test.ts` | L3-4 | ポジション別守備機会分布（NPB実データと照合） |
| `src/engine/__tests__/batted-ball-physics.test.ts` | L1-2 | 打球生成・打球種別分類の基本テスト |
| `scripts/test-balance-full.ts` | L4 | 1000試合バランステスト（品質ゲート・exit code判定） |
| `scripts/test-fielding-grid.ts` | L3 | グリッドテストのスタンドアロン版（詳細ログ出力） |
| `scripts/test-fielding-grid-excel.ts` | L3 | グリッドテスト結果のExcel出力（目視確認用） |
| `scripts/check-errors.ts` | 診断 | エラーパターン分析（バグ調査用） |
| `scripts/diagnose-fielding.ts` | 診断 | 守備AI診断レポート（詳細統計出力） |

---

## 関連ドキュメント

- `docs/fielding-test-guide.md` — 守備AI固有のテスト詳細（Layer 2サニティルール全10件、よくある失敗パターンと対処）
- `docs/baseball-knowledge.md` — NPBベンチマーク値（バランステストの基準根拠）
- `docs/fielding-distribution-analysis.md` — 守備機会分布のNPB実データ分析
