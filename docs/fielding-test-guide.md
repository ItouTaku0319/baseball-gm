# 守備AIテストガイド

エージェント型守備AI（`fielding-agent.ts`）のテスト手順・注意事項・品質基準。

## テスト体系

```
Layer 1: 単体テスト        — 各関数が正しい値を返すか
Layer 2: 野手視点テスト    — 「自分がその位置にいたら？」の常識チェック
Layer 3: グリッドテスト    — 5,586パターンの統計ゲート
Layer 4: バランステスト    — 1000試合のNPB準拠チェック
```

各レイヤーは前のレイヤーが通ってから意味を持つ。Layer 2を飛ばすと「平均は正常だけど個別がおかしい」が漏れる。

---

## Layer 1: 単体テスト

### 対象関数と検証ポイント

| 関数 | 検証内容 |
|------|---------|
| `createBallTrajectory` | ゴロ: `getPositionAt(flightTime)` = `landingPos`。フライ: `getHeightAt(0)` = BAT_HEIGHT, `getHeightAt(flightTime)` ≈ 0 |
| `getSpeedAt` | ゴロ: t=0で最大、t=stopTimeで0。フライ: 常に0 |
| `createAgents` | 9人のエージェント生成、初期位置が`DEFAULT_FIELDER_POSITIONS`と一致 |
| `updatePerception` | noiseScale=0で`perceivedLanding` = `landingPos`（完全一致） |
| `moveAgent` | dt秒後の位置が maxSpeed×dt 以下の移動量 |
| `resolveCallOffs` | CF(8) vs LF(7) → LFがyield。CF(8) vs SS(6) → SSがyield |
| `checkGroundBallIntercept` | 線分-点距離 < CATCH_RADIUS_IF で捕球成功 |
| `checkFlyCatchAtLanding` | 距離順: standard → running → diving の判定順 |
| `calcThrowTime` | 60m以上は中継経由。中継なしのフォールバック確認 |
| `advanceRunnersPhysical` | HR/walk等は既存ロジック委譲。hit系のみ物理計算 |

### テスト時の注意

- **rng固定**: `options.random = () => 0.5` で乱数依存を排除
- **noiseScale=0**: 知覚ノイズなしで決定的テスト
- **dt=0.1**: ループのdt精度に依存するテストは ±0.05秒の誤差許容

---

## Layer 2: 野手視点サニティチェック（重要）

### コンセプト

> 「自分がその位置のフィールドプレーヤーだったら、この結果はどうか？」

統計ゲートは平均値を保証するが、個別パターンの異常を見逃す。
野手視点チェックは**1パターンごとに**「これはおかしくないか」を判定する。

### 実装方法

グリッドテストの各パターンに対して、結果と状況の組み合わせが「ありえない」かを判定する。
`allRows` の各行に対して以下のルールを適用し、違反数 = 0 を要求する。

### ルール一覧

#### R1: 目の前の打球は捕れる

```
条件: 最寄り野手との距離 < 3m && 滞空時間 > 1.5秒
期待: result = out
理由: 3m先のフライが1.5秒以上滞空してたら、プロなら確実に捕る
```

#### R2: 超低速打球はほぼアウト

```
条件: exitVelocity <= 50km/h && launchAngle >= 0
期待: result = out || popupOut
理由: 50km/h以下の打球は全ポジションが余裕で到達できる
      （ファウルライン際の極端なケースは除外: dir < 5 || dir > 85）
```

#### R3: ポップフライは必ずアウト

```
条件: ballType = "popup"
期待: result = popupOut || out || homerun(160km/h超の理論値)
理由: ポップフライは高く上がって近くに落ちる。プロが落とすことはない
      ※ HRは極端な物理パターンでのみ許容
```

#### R4: 内野手の守備範囲内ゴロはアウト

```
条件: ballType = "ground_ball" && 最寄り内野手(3-6)までの経路距離 < 2m
期待: result = out || infieldHit（際どいタイミングは許容）
理由: 正面のゴロを後ろに逸らすのはエラーであって、ヒットではない
```

#### R5: 外野手定位置直撃フライはアウト

```
条件: ballType = "fly_ball" && 外野手(7-9)の定位置との距離 < 5m && 滞空時間 > 2秒
期待: result = out
理由: 定位置から5m以内のフライを2秒あって捕れないのはおかしい
```

#### R6: 遠距離打球にP/Cが出ていかない

```
条件: landing.distance > 40m && result != out
期待: retriever != P(1) && retriever != C(2)
理由: 40m以上の打球をPやCが回収に行くのはありえない
      （現行テストの「遠距離P/C回収」エラーパターンの拡張版）
```

#### R7: 浅い打球に外野手が出てこない

```
条件: landing.distance < 20m && ballType = "ground_ball"
期待: retriever = IF(3-6) || P(1) || C(2)
理由: ホームから20m以内のゴロを外野手が処理するのはありえない
```

#### R8: 深い打球に内野手が追わない

```
条件: landing.distance > 55m && result != out
期待: retriever = OF(7-9)
理由: 55m超の打球を内野手が回収に走るのはありえない
      （中継カットオフとは別。回収者=retrieverの話）
```

#### R9: ライナーの距離別アウト期待

```
条件: ballType = "line_drive"
- distance < 10m  → アウト率 >= 90%（目の前の弾丸ライナー）
- distance 10-25m → アウト率 >= 40%（内野ライナー）
- distance 25-50m → アウト率 >= 20%（外野前ライナー）
理由: ライナーは速いが、近ければ反射的に捕れる
```

#### R10: ゴロで三塁打は発生しない

```
条件: ballType = "ground_ball"
期待: result != "triple"
理由: ゴロで三塁まで到達するのは現実にはほぼ発生しない
      （ランニングHRも同様だがゴロでは不可）
```

### テストコード構造（案）

```typescript
describe("野手視点サニティチェック", () => {
  it("R1: 目の前のフライは捕れる", () => {
    const violations = allRows.filter(r => {
      // 条件: 最寄り野手3m以内 + 滞空1.5秒以上のフライ
      // → outでなければ違反
    });
    if (violations.length > 0) {
      console.log("R1違反:", violations.slice(0, 5));
    }
    expect(violations.length).toBe(0);
  });

  // R2-R10 同様...
});
```

### 判定に必要な追加情報

現行の`Row`型には以下が不足している。エージェント版では追加すること:

| フィールド | 用途 |
|-----------|------|
| `nearestFielderDist` | 最寄り野手と着地点の距離 (R1, R4, R5) |
| `flightTime` | 滞空時間 (R1, R5) |
| `nearestFielderPos` | 最寄り野手のポジション番号 (R4) |
| `landingPos` | 着地座標 {x, y} (R5の定位置距離計算) |

---

## Layer 3: グリッドテスト（5,586パターン）

### 現行ゲート（維持）

| ゲート | 基準 | 目的 |
|--------|------|------|
| 0-15mフライアウト率 | >= 80% | 近距離フライの確実な捕球 |
| 15-30mフライアウト率 | >= 30% | 内野フライの適度な捕球 |
| 遠距離P/C回収 | = 0件 | P/Cが遠征しない |
| 浅ゴロOF回収 | = 0件 | OFが浅い打球を取らない |
| 深打球IF回収 | = 0件 | IFが深い打球を追わない |
| ゴロ方向別アウト率 | >= 50% | 方向による偏りなし |

### エージェント版で追加すべきゲート

| ゲート | 基準 | 理由 |
|--------|------|------|
| ライナーアウト率（全体） | >= 55% | 現行36.7%が低すぎる。目標60-70% |
| 30-60mフライアウト率 | >= 60% | 外野正面の定位置フライ |
| 60-90mフライアウト率 | >= 40% | 外野の守備範囲ギリギリ |
| 内野ゴロアウト率（15-35m） | >= 65% | 内野ゴロの基本 |
| ダイビングキャッチ率 | 3-8% | 多すぎず少なすぎず |
| エラー率 | 1-4% | NPB準拠 |
| 10度境界スパイク | < 20%ジャンプ | 9°→10°で安打率が跳ね上がらない |

### パラメータ空間

```
方向:     0, 5, 10, ... 90° (19値)
初速:     40, 50, 60, ... 170 km/h (14値)
打球角度: -15, -12, -9, ... 45° (21値)
→ 19 × 14 × 21 = 5,586パターン
```

### エージェント版テストの注意点

1. **noiseScale=0で実行**: 知覚ノイズありだと同じパターンで結果が変わる
2. **rng固定**: `() => 0.5` でダイビングキャッチ等の乱数を固定
3. **タイムライン不要**: `collectTimeline=false` で高速化
4. **現行テストとの並行運用**: 移行期間中は旧テスト・新テスト両方通すこと

---

## Layer 4: バランステスト（1000試合）

### 実行方法

```bash
npx tsx scripts/test-balance-full.ts --games=1000
```

### NPB準拠ゲート

| 指標 | 下限 | 上限 | NPB参考 |
|------|------|------|---------|
| AVG | .240 | .280 | .255前後 |
| HR/試合 | 1.0 | 1.5 | 1.1 |
| K% | 15% | 25% | 20% |
| BB% | 7% | 12% | 9% |
| BABIP | .280 | .320 | .300 |
| GO/AO | 0.8 | 1.3 | 1.0 |

### エージェント版で追加確認すべき指標

| 指標 | 期待範囲 | 確認方法 |
|------|---------|---------|
| 犠牲フライ/試合 | 0.3-0.6 | タッグアップ物理の妥当性 |
| 併殺/試合 | 0.7-1.0 | DP判定ロジックの妥当性 |
| 守備機会P分布 | 3-5% | 投手の守備参加頻度 |
| 守備機会C分布 | 2-4% | 捕手のフライ捕球頻度 |
| エラー率 | 1-3% | ファンブル+落球の合計 |
| 三塁打/試合 | 0.1-0.3 | 走者進塁物理の妥当性 |
| ライナーアウト率 | 55-70% | エージェント版の目標 |

---

## テスト実行順序

### Phase 1: 基盤確認（実装直後）

```bash
# 1. ビルド通過
npm run build

# 2. 単体テスト
npm run test -- --run src/engine/__tests__/fielding-agent.test.ts

# 3. 軌道一致確認
# createBallTrajectory の landingPos が calcBallLanding と一致するか
```

### Phase 2: 品質ゲート（ロジック確定後）

```bash
# 4. グリッドテスト（noiseScale=0, rng固定）
npm run test -- --run src/engine/__tests__/fielding-grid.test.ts

# 5. 野手視点テスト
npm run test -- --run src/engine/__tests__/fielding-sanity.test.ts
```

### Phase 3: 統合確認（simulation.ts接続後）

```bash
# 6. バランステスト
npx tsx scripts/test-balance-full.ts --games=1000

# 7. Excel出力で目視確認
npx tsx scripts/test-fielding-grid-excel.ts

# 8. NPB分布テスト
npm run test -- --run src/engine/__tests__/fielding-distribution.test.ts
```

---

## よくある失敗パターンと対処

### 「ライナーアウト率が低い」
- **原因**: ライナーは低く速く、知覚ノイズが大きい（2倍）→ 野手が正しい位置に行けない
- **対処**: noiseScale=0で再テスト → ノイズなしでも低ければ走速/反応時間の問題

### 「10度境界でスパイク」
- **原因**: ゴロ→ライナーの切り替わりで物理モデルが不連続
- **対処**: `classifyBattedBallType`の閾値付近（8-12度）を細かくサンプリング

### 「ゴロが特定方向だけ抜ける」
- **原因**: SS-2B間（dir=40-50°）に守備の穴がある
- **対処**: エージェントの初期位置調整。`DEFAULT_FIELDER_POSITIONS`の2B/SSを微調整

### 「外野フライが全部ヒット」
- **原因**: 外野手の走速が足りない or 知覚ノイズで逆方向に走る
- **対処**: maxSpeed の計算確認。fielding skill → speed の変換式を見直す

### 「DPが多すぎる/少なすぎる」
- **原因**: dpRate の定数が不適切
- **対処**: `resolveGroundOut`の`dpRate = 0.12 + ...`を調整

### 「犠牲フライが少なすぎる」
- **原因**: タッグアップ試行率（60%）or 安全条件（throwTime + 0.3）が厳しすぎる
- **対処**: 試行率を上げるか、マージンを緩和

---

## テスト設計の原則

1. **決定的テストを基本にする**: noiseScale=0, rng固定。乱数ありテストは別途
2. **統計テストは母数を明記**: 「5,586中の○○件」のように分母を示す
3. **失敗時にパターンを表示**: `console.log` で違反パターンの先頭5件を出す
4. **段階的に厳しくする**: 最初は緩いゲート → 安定したら基準を引き上げ
5. **Layer 2を最も重視する**: 統計は嘘をつける。個別の異常を見逃さない
