# 守備シミュレーション 進化ロードマップ

守備シミュレーションの現状アーキテクチャと、完全シミュレーション（理想形）に向けた段階的な進化計画。

---

## 1. 現状のアーキテクチャ

```
打球生成 → calcBallLanding(着地点計算)
  → createBallTrajectory(時系列座標、fielding-agent.tsが使用)
  → 9人エージェントが独立評価(fielding-agent.ts)
    → 知覚ノイズ付き着地点推定
    → 毎フレーム(0.1秒)で位置更新・到達判定
    → ゴロ経路遮断 / フライ着地点収束 のどちらかで捕球判定
  → 走者進塁（打球結果に基づく後処理）
  → 送球・併殺（到達時間ベースの簡易判定）
```

### 現状の特徴

- `fielding-ai.ts`: 座標系・デフォルト守備位置・FielderDecision型の定義
- `fielding-agent.ts`: 9人が独立してフレームループを回すエージェント型AI
- `ball-trajectory.ts`: `calcBallLanding` と互換の物理モデルで時刻 t の座標を計算
- 打球は「着地点 + 飛行時間」が確定した後にエージェントが追跡（同時進行ではない）
- 走者判断は打球結果確定後に独立処理（打球処理と並行ではない）
- 送球は「到達時間」で一発判定（物理的な送球軌道はない）
- 中継プレーは `calcThrowTime` 内で 60m 超の場合に所要時間を加算する形で簡略化

---

## 2. 理想形（完全シミュレーション）

```
打球生成 → ボール物理（毎フレーム位置・速度更新）
  → 9人野手が同時に判断・移動（毎フレーム）
  → 走者・打者走者も同時に移動（毎フレーム）
  → 捕球 → 送球（物理軌道）→ カットオフ判断 → タッチプレー
  → 全過程が座標ログとして記録 → リプレイ可能
```

### 理想の特徴

- 打球・野手・走者がすべて同一タイムラインで毎フレーム更新
- 送球も投げる方向・速度・到達時間を物理的に計算
- 中継プレー（カットオフマン）が明示的なエージェントとして機能
- タッグアップ判断がフライの滞空中にリアルタイムで行われる
- 打球結果画面でフルリプレイ可能

---

## 3. 進化フェーズ

**Phase 1: 現状（完了）**

着地点ベース + エージェント型9人独立評価。結果は NPB 準拠だが、過程の可視化は限定的。

**Phase 2: 打球軌道の可視化**

`ball-trajectory.ts` の時系列座標を UI 側で使い、打球の飛跡を描画する。野手の最終位置だけでなく移動経路も記録してトレース可能にする。`analytics` ページの打球分析で部分的に実装済み。

**Phase 3: 野手移動のフレームシミュレーション**

野手の「追いかけ中」「待機中」「捕球」のステート遷移と毎フレームの位置を保存し、結果画面でリプレイ可能にする。現行の `AgentTimelineEntry` / `AgentSnapshot` を UI に接続する形で実現できる。

**Phase 4: 走者の同時進行**

走者もフレーム単位で移動し、打球処理と並行して判断させる。走塁ロジック（`advanceRunnersPhysical`）の大改修が必要。

走者エージェントの判断モデル:

```
【0-1アウト + フライ/ライナー】
t=0:   打球発射 → 「フライだ」→ ハーフウェイ(次塁と現塁の中間)へ移動
t=0~2: 打球の深さを判断
  浅い(内野付近) → 帰塁準備（捕球されたら戻る）
  深い(外野)     → タッグアップ切替（現塁に戻ってスタンバイ）
t=捕球: 捕球された → タッグアップスタート or ステイ
         落ちた     → 次塁以降へ進塁判断（送球との競争）

【2アウト + フライ/ライナー】
t=0: 打球発射 → 「2アウトだ。落ちる前提で全力！」→ 即スタート
  捕球された → チェンジ（進塁は無効）
  落ちた     → そのまま全力疾走（ホームまで狙う）

【ゴロ】
t=0: 打球発射 → 通常進塁判断
  0-1アウト: 後ろの走者に押される状況なら進塁、それ以外は打球方向と距離で判断
  2アウト:   全力進塁（フォースアウトとの競争）
  併殺警戒:  0アウト1塁は併殺リスクを考慮して判断
```

判断に影響するパラメータ:
| パラメータ | 影響 |
|---|---|
| アウトカウント | 0-1アウト=慎重、2アウト=全力 |
| 打球の深さ | 深い=タッグアップ有利、浅い=ステイ |
| 打球種別 | フライ=ハーフウェイ、ライナー=フリーズ、ゴロ=即判断 |
| 走者speed | 高い=タッグアップ・進塁に積極的 |
| 外野手arm | 強肩=タッグアップ・進塁に消極的 |
| 現在の塁 | 3塁=ホームイン判断、2塁=三塁到達判断、1塁=二塁到達判断 |
| 得点差 | 大量リード=慎重、僅差/ビハインド=積極的 |

走者のステート遷移:
```
WAITING → HALFWAY → TAGGING_UP → RUNNING → ARRIVED
                  → RETREATING → ARRIVED(元の塁)
         → RUNNING(2アウト時) → ARRIVED
```

全走者の座標を毎フレームで記録し、リプレイ画面で確認可能にする。

**Phase 5: 送球の物理化**

送球に方向・速度・軌道を持たせる。`calcThrowTime` を物理モデルに置き換え、カットオフマンが受けて投げる過程を明示的にシミュレートする。中継エージェントを追加する形で実装可能。

**Phase 6: 完全統合**

打球・野手・走者・送球がすべて同一タイムラインで進行。全プレーが座標ログとして記録され、フルリプレイ可能になる。

---

## 4. 各フェーズの実装コスト

| Phase | コスト | 主な作業 |
|---|---|---|
| 2 | 低〜中 | `ball-trajectory.ts` 拡張、analytics UI 側の対応 |
| 3 | 中 | `AgentTimeline` を結果画面に接続 |
| 4 | 中〜高 | `advanceRunnersPhysical` のフレームループ化 |
| 5 | 中〜高 | 送球モデル新規実装、中継エージェント追加 |
| 6 | 高 | 統合・UI・パフォーマンス（1000試合テストへの影響） |

---

## 5. 判断ポイント

- フレームシミュレーションに近づくほど計算コストが増える。1000試合バランステスト（`scripts/test-balance-full.ts`）の実行時間への影響を測定しながら進める
- フレームシミュレーションでは乱数管理が重要になる。同一入力で同一結果が再現できるよう rng を引数として渡す設計を維持する
- Phase 3 以降は `collectTimeline` フラグで有効/無効を切り替え可能にし、バランステスト時は無効化してパフォーマンスを維持する
- 段階的に進めることで各フェーズにテストを追加して品質を保てる（`fielding-test-guide.md` のテスト体系を活用）
