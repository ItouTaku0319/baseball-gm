# Baseball GM - NPB風野球シミュレーションゲーム

## プロジェクト概要

NPB（日本プロ野球）をモデルにした野球GMシミュレーションゲーム。パワプロのペナントモードを参考にしたUI/UXで、プレイヤーは1球団のGMとしてチームを運営する。

## 技術スタック

- **フレームワーク**: Next.js 16 (App Router)
- **言語**: TypeScript 5 (strict mode)
- **UI**: React 19 + Tailwind CSS 4
- **状態管理**: Zustand 5
- **データ永続化**: localStorage
- **パスエイリアス**: `@/*` → `src/*`

## 開発コマンド

```bash
npm run dev      # 開発サーバー起動
npm run build    # プロダクションビルド
npm run lint     # ESLint実行
```

## ディレクトリ構成

```
src/
├── app/                    # Next.js App Router ページ
│   ├── page.tsx           # タイトル画面（セーブデータ一覧）
│   ├── layout.tsx         # ルートレイアウト（Geistフォント）
│   └── game/
│       ├── new/page.tsx   # 新規ゲーム作成（チーム選択）
│       └── [id]/
│           ├── page.tsx       # ダッシュボード（成績・順位・シム操作）
│           ├── roster/page.tsx    # ロスター（選手一覧・能力）
│           ├── standings/page.tsx # 順位表
│           ├── schedule/page.tsx  # スケジュール（日程・結果）
│           ├── stats/page.tsx     # 成績（打撃/投手・セイバー指標）
│           ├── analytics/page.tsx # 打球分析（シーズンデータ・診断シミュ）
│           ├── pitching/page.tsx  # 投球分析（ストライクゾーン・球種分析）
│           ├── draft/page.tsx     # ドラフト（未実装UI）
│           └── trade/page.tsx     # トレード（未実装UI）
├── components/             # 共通UIコンポーネント
│   ├── player-ability-card.tsx # 選手能力カード・グレード色・弾道アイコン
│   ├── lineup-field.tsx       # SVGフィールド図（守備位置ノード）
│   └── lineup-card.tsx        # 打順カード（選手情報+能力値+成績）
├── engine/                 # ゲームエンジン（純粋関数）
│   ├── simulation.ts      # 試合シミュレーション（打席・走塁）
│   ├── fielding-ai.ts     # 守備AI（座標系・到達時間計算・判断ロジック）
│   ├── season.ts          # シーズン生成・スケジュール・順位
│   ├── season-advancement.ts # シーズン進行（1試合/1日/1週間/自チームまで）
│   ├── draft.ts           # ドラフトエンジン（ウェーバー方式）
│   └── trade.ts           # トレードエンジン（選手価値算出・CPU交渉）
├── models/                 # 型定義
│   ├── player.ts          # Player, BatterSeasonStats, PitcherSeasonStats
│   ├── team.ts            # Team, TeamRecord
│   ├── league.ts          # Season, ScheduleEntry, League, GameResult
│   └── game-state.ts      # GameState（セーブデータ構造）
├── store/
│   └── game-store.ts      # Zustandストア（ゲーム状態・アクション）
└── data/
    └── teams.ts           # 12チームテンプレート（セ6+パ6）
```

## アーキテクチャ方針

### エンジン層（`src/engine/`）
- **純粋関数**: `GameState` を受け取り新しい `GameState` を返す
- UIやストアに依存しない
- テスト容易性を重視

### ストア層（`src/store/`）
- Zustandでグローバル状態管理
- localStorageでセーブ/ロード
- エンジン関数をラップしてアクションとして公開

### UI層（`src/app/`）
- Next.js App Routerの規約に従う
- 全ページ `"use client"` （ゲームなのでSSR不要）
- Tailwind CSSでスタイリング

## ドキュメント体系

| ファイル | 役割 | 誰が更新 |
|---|---|---|
| `CLAUDE.md` | プロジェクトの知識・ルール（Wiki） | PM（蓄積） |
| `task.md` | やることリスト（TODO） | 人間 + PM（提案） |
| `GAME_SPEC.md` | ゲームルール・数値設計の仕様 | PM（実装変更時に同期） |

`GAME_SPEC.md` はゲームバランスに関わる実装を行う際に必ず参照する。
確率・計算式・パラメータを変更した場合は、コードと仕様書を同時に更新する。

## コーディング規約

### 全般
- 言語: UIテキスト・コメントは日本語
- 数値表示: `tabular-nums` + 右寄せで統一
- 色使い: 自チーム=blue-400、勝=blue、敗=red、引分=gray
- 能力値の色分け: 80+=gold、65+=green、50+=white、35+=orange、<35=red

### スケジュール構成（NPB準拠 143試合制）
- 同リーグ戦: 各対戦25試合 × 5チーム = 125試合
- 交流戦: 各対戦3試合 × 6チーム = 18試合
- 合計: 143試合/チーム、858試合エントリ、143日
- 1日6試合（セ3+パ3）

### 成績指標
- **基本打撃**: 打率, 本塁打, 打点, 盗塁, 四球, 三振, 出塁率, 長打率
- **セイバー打撃**: K%, BB%, BB/K, ISO, BABIP, wOBA, wRC+, WAR
- **基本投手**: 防御率, 勝, 敗, 投球回, 奪三振, 四球, 被安打, WHIP, セーブ
- **セイバー投手**: K/9, BB/9, HR/9, K/BB, FIP, WAR
- 投球回は `X Y/3` 形式（例: `162 1/3`）

## task.md の運用方法

`task.md` はプロジェクトのロードマップ。人間が方向性を決め、PMが実態に合わせて育てる。

### 人間の役割
- 新しいタスクの追加（やりたいことを書く）
- 優先度の変更・方針の決定
- PMが追加した提案タスクの承認/却下

### PMの役割（タスク完了時に必ず実行）

#### task.md の更新
1. **完了マーク**: 実装したタスクに `[x]` をつける
2. **発見タスクの追記**: 実装中に気づいた課題・改善点を `## PMからの提案` セクションに追加
3. **依存関係メモ**: 「Xを先にやらないとYができない」等の発見を記載
4. **既存タスクの補足**: 実装してみて分かった詳細や注意点を既存タスクに追記

#### CLAUDE.md の更新
1. **設計判断の記録**: なぜその実装方法を選んだかを `## 設計メモ` に追記
2. **既知の問題**: バグやパフォーマンス問題など、今は直さないが把握しておくべきことを `## 既知の問題` に追記
3. **ファイル構成の更新**: 新しいファイルを追加した場合、ディレクトリ構成を更新

### 提案タスクのルール
- PMが追加するタスクは task.md の `## PMからの提案` セクションにまとめる
- 人間が確認して正式タスクに昇格させるか、却下する
- PMは勝手に正式タスクを追加・削除しない（提案のみ）

## 開発ワークフロー

1. `task.md` で次に取り組むタスクを確認
2. 関連ファイルを読んで現状を把握
3. 必要に応じてプランモードで設計
4. 実装 → `npm run build` で確認
5. 動作確認後、必要に応じて `task.md` を更新

## 進捗の可視化ルール

人間側からは「何をしているか」「何で詰まっているか」が見えないことが最大のストレス。
PMは常に人間に状況が伝わる状態を維持すること。

### 基本ルール
- 複数ステップの作業を始める際は、必ず TaskCreate でタスクリストを作成する
- 各タスクに着手したら `in_progress` に更新、完了したら `completed` に更新
- これによりUI上でスピナーと進捗が表示され、人間が現在の状態を把握できる

### サブエージェント委譲時の報告
- サブエージェントに投げる**前**に「○○を実装くんに任せます」とテキストで報告する
- サブエージェントの内部進捗は人間には見えないため、PMが中継役を担う
- 長時間かかりそうな場合は、何を待っているか説明する

### エラー・詰まり時の即時報告
- ビルドエラーやテスト失敗でループしそうになったら、すぐ状況を人間に報告する
- 「何が起きているか」「どう対処するか」を簡潔に伝えてから対応に入る
- 黙って何度もリトライしない

## チーム体制（サブエージェント）

このプロジェクトではClaude Codeのメインセッションが**PM（プロジェクトマネージャー）**として振る舞い、
専門エージェントに作業を委譲する。定義ファイルは `.claude/agents/` にある。

### メンバー

| 役割 | エージェント名 | モデル | 権限 |
|---|---|---|---|
| PM（あなた自身） | メインセッション | opus | 全権限 |
| 実装くん | `implementer` | sonnet | Read/Write/Edit/Bash |
| テストくん | `tester` | haiku | Read/Bash（読み取り専用） |
| レビューくん | `reviewer` | sonnet | Read/Grep（編集不可） |

### ワークフロー

```
1. PM: task.md を読み、タスクを分解
2. PM → 実装くん: 実装を委譲（Taskツールで呼び出し）
3. 実装くん: コード実装 → npm run build → 結果を返す
4. [自動] hook: build + lint チェック → 失敗時はPMに通知
5. PM → レビューくん: コードレビューを委譲（大きい変更の場合）
6. PM: 問題があれば実装くんに差し戻し
7. PM: git add → commit（日本語で変更内容を要約） → push origin
8. PM: task.md を更新
```

### 運用ルール
- テストくん・レビューくんはコードを編集しない（指摘のみ）
- 複数の独立したタスクは並列で実装くんに委譲してよい
- `models/player.ts` や `store/game-store.ts` を触るタスクは並列にしない

### 自動化（Hooks）
以下はhooksで自動実行されるため、PMが手動で呼ぶ必要はない:
- **Edit/Write後**: 自動で `npm run build` → 失敗時はClaudeに通知され自動修正
- **実装くん完了後**: 自動で build + lint チェック → 通過後はPMにcommit&push指示が出る

テストくんを明示的に呼ぶのは、hookでカバーできない深いコード検証が必要な場合のみ。
レビューくんは大きな機能実装の後に呼ぶ。小さな修正では省略可。

### Git運用
- QAチェック通過後、PMが `git add` → `git commit` → `git push origin` を実行する
- コミットメッセージは日本語で変更内容を要約する
- 1タスク1コミットが基本。大きなタスクは論理的な単位で分割してよい
- force-pushは使わない。mainブランチへの直pushは小さな変更のみ許可

## 並列作業のルール

### 基本原則
- 触るファイルが被らないタスクは並列実行OK
- 被る場合は `isolation: "worktree"` で隔離するか、順番に実行
- 読み取り専用の作業（調査・レビュー）は常に並列OK

### サブエージェントへの委譲
複数タスクを同時に進める場合、Task toolでサブエージェントに委譲する。
- 各サブエージェントには明確で小さいタスクを1つ割り当てる
- ファイルが被るタスクは同じサブエージェントに渡すか、順番に実行
- サブエージェント同士はお互いの作業を見れないことに注意

### 並列化の判断基準

| 条件 | 対応 |
|---|---|
| 触るファイルが完全に別 | 並列OK |
| 同じモデル型を使うが別ファイル | 並列OK（型の変更がなければ） |
| 同じファイルを編集する必要あり | worktreeで隔離 or 順番に実行 |
| 片方の結果がもう片方の前提 | 順番に実行（依存関係あり） |
| 調査・レビューのみ | 常に並列OK |

### このプロジェクトのファイル所有権の目安

| 領域 | 主要ファイル |
|---|---|
| 試合シミュレーション | `engine/simulation.ts` |
| シーズン管理 | `engine/season.ts`, `engine/season-advancement.ts` |
| ドラフト | `engine/draft.ts`, `app/game/[id]/draft/page.tsx` |
| トレード | `engine/trade.ts`, `app/game/[id]/trade/page.tsx` |
| 選手モデル | `models/player.ts` |
| チームモデル | `models/team.ts` |
| リーグモデル | `models/league.ts` |
| ゲーム状態 | `models/game-state.ts`, `store/game-store.ts` |
| ダッシュボード | `app/game/[id]/page.tsx` |
| ロスター | `app/game/[id]/roster/page.tsx` |
| 成績 | `app/game/[id]/stats/page.tsx` |
| 順位表 | `app/game/[id]/standings/page.tsx` |
| スケジュール | `app/game/[id]/schedule/page.tsx` |
| 打球分析 | `app/game/[id]/analytics/page.tsx` |
| 投球分析 | `app/game/[id]/pitching/page.tsx` |

**注意**: `models/player.ts` や `store/game-store.ts` は多くの機能から参照されるため、これらを変更するタスクは他と並列にしない。

## 設計メモ
<!-- PMが実装中に行った設計判断を記録する。次のセッションのClaudeが「なぜこうなっているか」を理解するため。 -->

- **スケジュール生成**: ラウンドロビンのローテーションアルゴリズム（1チーム固定、残り5チーム回転）で同リーグ日程を生成。交流戦はLatin Square法で1日の中でチーム重複が起きないよう配置。
- **セイバーメトリクス**: wOBAのリニアウェイト（BB=0.69, 1B=0.87, 2B=1.27, 3B=1.62, HR=2.10）はMLB 2023年基準値を使用。wRC+とWARはリーグ平均から算出するため、シーズン序盤は値がブレやすい。
- **FIP定数**: `cFIP = lgERA - (13*lgHR + 3*lgBB - 2*lgK) / lgIP` でリーグ実績から動的に算出。
- **打球処理エンジン**: 打席結果を「死球→四球→三振→インプレー」の確率チェーンで判定。インプレー時は打球タイプ（ゴロ/フライ/ライナー/ポップ）を決定し、タイプごとの重み付きランダムで守備位置を割り当て、該当野手の守備能力(fielding/catching/arm)で結果を判定する。投手はpitching側の守備能力を使用。
- **シンカー系ゴロ率ボーナス**: sinker/shootの球種レベルに応じてゴロ率を最大+7%。パワーの高い打者はフライ率が上がりゴロ率が下がる。
- **併殺打(GIDP)**: 1塁走者あり+2アウト未満+ゴロ時に判定。`0.12 + (1-speed/100)*0.06`。走力が低い打者ほど併殺率が高い。
- **守備成績(PO/A/E)**: 各打席結果に応じて守備側選手にPO(刺殺)/A(補殺)/E(失策)を記録。三振→捕手PO、ゴロアウト→処理野手A+1BにPO、フライ系→処理野手PO、併殺→処理野手A+中継パターンに応じたPO×2、盗塁死→捕手A+該当塁野手PO。守備率=(PO+A)/(PO+A+E)、RF=(PO+A)/G*9。
- **簡易UZR/DRS**: ポジション別平均との対比で算出。`rangeRuns = ((PO+A)/Gの差) * 0.8 * G`、`errorRuns = (E/Gの差) * 0.7 * G`。UZR = rangeRuns + errorRuns。プラス=平均以上の守備貢献。
- **投手打球系指標**: PitcherGameLog/PitcherSeasonStatsに全打球タイプ(groundBalls/flyBalls/lineDrives/popups)を記録。GB%/FB%/LD%は全打球(BIP)に対する割合。IFFB%=popup/(flyBalls+popups)。HR/FB=HR/flyBalls。
- **打球物理エンジン**: インプレー時に打球の方向(0-90°)・角度(-15~70°)・速度(80-185km/h)をガウス乱数で生成。打球方向はbatSide（左右打席）によるプル傾向あり。フィールダーはゾーンベースで幾何学的に決定（内野: 3B→SS→2B→1B、外野: LF→CF→RF）。HR判定は飛距離ベース（estimateDistance+getFenceDistance）。旧`determineBattedBallType`+`assignFielder`+`resolveInPlay`を置き換え。
- **バランス調整(v2→v3)**: v2でバレル閾値150→158km/h等のHR率引き下げ。v3で飛距離ベースHR判定に完全移行し、確率ベースの`max(0.01, hrRate)`を撤廃。ライナー安打率0.62、フライ安打率0.12は維持。
- **守備バグ修正**: (1) 1B自己処理ゴロでA+POの二重記録→POのみに修正(3U)。(2) 外野中継プレーで外野手にもAを記録。(3) buildFielderMapにfullRoster引数を追加し、打順外ポジション(2B/CF/C等)をフルロスターから補完。
- **AtBatLog診断機能**: simulateGameにoptions引数({collectAtBatLogs?: boolean})を追加。trueの場合、各打席の方向/角度/速度/結果をAtBatLogとして収集。通常シーズンシミュでは収集しない（パフォーマンス影響なし）。
- **打球分析ツール**: analytics/page.tsxに2タブ構成。タブ1=シーズンデータ集計（GB%/FB%/LD%/打撃サマリー/守備機会）。タブ2=診断シミュレーション（N試合実行→打球物理サマリー/タイプ別結果/守備集計/打席ログ/CSV出力）。

- **守備機会分布調整(NPB準拠)**: NPB 2024実データを基に外野ゾーン・フォースアウト率・投手関与率等を調整。外野ゾーン: LF<33°, CF<52°, RF≥52°（ノイズσ=7°）。フォースアウト率95%→40%。投手返し条件拡大(25-65°, <120km/h, 20%)。外野中継補殺率20%→3%。ライナー振り分け: >145km/h||>16°で外野。捕手関与プレー(5%)追加。詳細は `docs/fielding-distribution-analysis.md` 参照。
- **打球分析ページ大幅強化**: AtBatLogからbatterName/pitcherNameを削除しIDのみで逆引き（ストレージ約300KB節約）。自チーム試合のみcollectAtBatLogs=trueでログ収集（143試合×75打席≈860KB）。シーズンデータタブに打席ログ・選手フィルタ（能力値カード付き）・打球タイプ分布のアウトカムフィルタを追加。結果表示を日本語化・色分け（HR=赤太字、安打=暖色、アウト=灰色）。ホームランの守備位置を「-」に。共通AtBatLogTableコンポーネントで両タブのログ表示を統一。打球タイプ分布のアウトカムフィルタは「全体」がpitcherStats集計、「ヒット」「アウト」がatBatLogs集計で切り替え。
- **飛距離ベースHR判定**: 旧来の確率ベースHR判定(max(0.01, hrRate))を撤廃。放物運動+空気抵抗補正(dragFactor=0.87, 打点高さ1.2m)で推定飛距離を計算し、NPB標準フェンス距離(両翼100m, 中堅122m: `100+22*sin(dir*π/90)`)との比較で判定。ratio≥1.05でHR確定、0.95-1.05でフェンス際ランダム（パワー補正付き）、<0.95はHR不可。128km/h/10.5°=42mのように物理的にフェンスに届かない打球はHRにならない。
- **打球軌道可視化**: SVGベースで2ビュー。フィールドビュー(俯瞰)は守備9人のデフォルト位置・走者・アウトカウントを表示、プレー再生アニメーション付き（ボール飛行→守備移動→走者進塁をrequestAnimationFrameで2.5秒再生）。サイドビュー(横)は放物線軌道を30点でサンプリング、フェンス位置・最高到達点・飛距離を表示。AtBatLogTableの行クリックでポップアップ表示。
- **AtBatLog塁状況記録**: basesBeforePlay([1塁,2塁,3塁]のboolean配列)とoutsBeforePlay(アウト数)を打席前にキャプチャして記録。アニメーション再生やプレー状況の復元に使用。
- **ERA+/OPS+**: ERA+=(lgERA/ERA)*100、OPS+=(OBP/lgOBP+SLG/lgSLG-1)*100。100がリーグ平均。成績ページのセイバータブにソート可能列として追加。100以上=緑、未満=赤で色分け。
- **打高バランス修正(v4)**: LD率35%→20-22%目標（ゴロ閾値angle<5→<10, ev閾値100→130）。K%15%→20-22%目標（基準値0.14→0.20, contact影響0.06→0.10）。ライナーからのHR判定を削除（fly_ballのみ）。犠飛率50%→15%。ゴロ安打経路を新規追加（打球速度+守備力+ミート依存、8-30%のhitRate）。
- **成績ページソートトグル**: SortThに昇順/降順トグル追加。同列再クリックで方向切替。ERA/FIP/xFIP/失策はデフォルト昇順、他は降順。全ヘッダーにtitle属性で指標説明ツールチップを追加。
- **得点(runs)記録修正**: advanceRunnersの戻り値に`scoredRunners: Player[]`を追加。全生還走者（ヒット/四球/犠飛/エラー/FC/押し出し等）のrunsを正しく記録。従来はHR打者本人のみだったため runs≒HR になっていた。
- **バランス調整(v5→v6)**: v5でフライ閾値20→25°、HR最低確率5→1%、ev上限185→170。v6でdragFactor 0.87→0.70（空気抵抗24%→30%減）によりHR/試合5.3→2.7。検証結果: 打率.255, HR/試合2.7, R/試合7.0, K%19.2%。
- **HR率バランス調整(v7)**: パワーの速度係数を0.5→0.15に大幅低下（P100の速度mean: 157→139.5）。HR判定に弾道キャリーファクター[0.90, 1.00, 1.05, 1.10]を導入し、弾道×パワーの相関を実現。弾道別平均HR%: 弾道1=1.4%, 弾道2=3.8%, 弾道3=6.2%, 弾道4=9.0%。P45+弾道2=2.7%(NPB平均OK)。選手生成のパワー上限は実質95（overall80+spread15）で、P90+弾道4の歴代級スラッガーで~56本ペース。
- **弾道(trajectory)**: BatterAbilitiesに弾道(1-4)を追加。パワー相関で生成（`1 + (power/100)*2.5 ± 0.75`）。シミュレーションでは`angleMean += (trajectory-2)*3`で打球角度に影響（弾道1=-3°, 2=±0°, 3=+3°, 4=+6°）。HR判定時に弾道キャリーファクター[0.90, 1.00, 1.05, 1.10]で飛距離を補正（弾道1はキャリーが弱くHRが出にくい、弾道4はフライ打ちでHRが出やすい）。既存セーブ互換は`?? 2`でデフォルト。
- **打順画面UI改修**: フィールド図(SVG)+打順カードリストの2カラム(lgブレイクポイント)レスポンシブ。選択ベースのswap操作（1回目選択→2回目swap/差替え）。ベンチ選手は選択中のみクリック可能。ローテ/リリーフもドロップダウンから投手カード形式に変更、役割バッジ(守護神/SU/中継ぎ)付き。
- **選手総合値(Overall)**: 野手=`contact*2.2+power*2.2+speed*1.5+eye*1.5+fielding*1.2+arm*0.8+catching*0.6`、投手=`velNorm*2.0+control*2.5+stamina*1.5+mental*1.0+pitchBonus*3.0`（velNorm=(vel-120)/45*100, pitchBonus=min(100,Σlevel*12)）。1-999スケール、100刻みでS〜Gランク。gradeColor共用で色分け。ロスター・打順カード・投手カードに表示。
- **守備AI (fielding-ai.ts)**: 旧ゾーンベース守備を全面置き換え。2Dフィールド座標系で9野手の到達時間を物理計算し、ゴロは「捕球→送球→走者との競争」、フライ/ライナーは「着地前に到達→捕球試行」で結果判定。長打はバウンスペナルティモデル（着地後のボール追跡遅延: 1.4-4.4s, 深いほど大きい + フェンス壁リバウンド: +0.6-1.2s）で回収時間を計算し、送球時間vs走者の進塁時間で単打/二塁打/三塁打が自然に決まる。3B進塁は1.5s以上の余裕が必要（リスク回避）。dragFactor=0.60、ライナー反応遅延+0.3-0.5s、外野デフォルト位置65-73m。1000試合テスト: AVG.250, HR/試合1.33, K%18.5%, BB%7.6%, BABIP.297, GO/AO1.09、2B/試合1.15, 3B/試合0.10（全指標NPB範囲内、異常0件）。
- **投球分析(pitching/page.tsx)**: PitchTypeに`fastball`追加。各打席の「決め球」1球をselectPitch(重み付き抽選: ストレート=球速依存, 変化球=レベル依存, 結果で重み調整)とgeneratePitchLocation(制球で分散制御, 結果別コース傾向: 三振=低め外角, 四球=ゾーン外, HR=高め甘め)で逆算生成。collectAtBatLogs=true時のみ生成（パフォーマンス影響なし）。投球分析ページでストライクゾーンSVG(球種色ドット)・球種別成績テーブル・9分割コースヒートマップ(被打率色付け)・打席ログを表示。

## 指標について
https://1point02.jp/op/gnav/glossary/gls_index.aspx?cp=101
上のサイトを見たうえで実装可能なものや必要そうなものは実装すること。

## 既知の問題
<!-- 今は直さないが把握しておくべき問題を記録する。 -->

- **投手守備機会が少ない**: バント処理が未実装のため。バント機能の実装で改善予定。
- **守備成績(PO/A/E)の精度**: 守備AI移行後、旧ゾーンベースの守備機会記録ロジックとの整合性を検証中。フライボール率・ゴロアウト率は1000試合テストで正常範囲内。
- **フライボール安打率がやや高め(~20%)**: NPB標準(~15%)よりやや高い。外野手のデフォルト位置(65-73m)調整で改善可能。
