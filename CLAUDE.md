# Baseball GM - NPB風野球シミュレーションゲーム

## プロジェクト概要

NPB（日本プロ野球）をモデルにした野球GMシミュレーションゲーム。パワプロのペナントモードを参考にしたUI/UXで、プレイヤーは1球団のGMとしてチームを運営する。

## コア原則

- **シンプル第一**: 変更は最小影響で。必要な箇所だけ変更し、新たなバグを生まない
- **根本原因を解決**: 応急処置・ハック禁止。シニアエンジニア水準の実装を行う
- **即停止・再プラン**: 問題が起きたら無理に進めず、立ち止まって原因分析→再プランする
- **完了前に自問**: 「スタッフエンジニアが承認するか？」を提出前にセルフチェック

## 技術スタック

- **フレームワーク**: Next.js 16 (App Router)
- **言語**: TypeScript 5 (strict mode)
- **UI**: React 19 + Tailwind CSS 4
- **状態管理**: Zustand 5
- **データ永続化**: IndexedDB (Dexie.js) — `src/db/`
- **テスト**: Vitest 4
- **パスエイリアス**: `@/*` → `src/*`

## 開発コマンド

```bash
npm run dev      # 開発サーバー起動
npm run build    # プロダクションビルド
npm run lint     # ESLint実行
npm run test     # Vitestテスト実行
npx tsx scripts/test-balance-full.ts --games=1000  # バランステスト（品質ゲート）
```

**重要**: Bashコマンドは `cd` プレフィックスなしで直接実行すること。ワーキングディレクトリはプロジェクトルートで維持される。`cd` を付けると許可パターン(`Bash(git *)` 等)にマッチしなくなり、不要な許可プロンプトが発生する。

## ディレクトリ構成

```
src/
├── app/          # Next.js App Router ページ（全ページ "use client"）
├── components/   # 共通UIコンポーネント
├── engine/       # ゲームエンジン（純粋関数） ← 中核
├── models/       # 型定義（Player, Team, Season, GameState）
├── db/           # データ永続化（IndexedDB / Dexie.js）
├── store/        # Zustand状態管理（game-store.ts）
└── data/         # チームテンプレート（12球団）
scripts/          # バランステスト等のスクリプト
```

詳細は `docs/project-map.md` を参照。

## アーキテクチャ方針

### エンジン層（`src/engine/`）
- **純粋関数**: `GameState` を受け取り新しい `GameState` を返す
- UIやストアに依存しない
- 物理定数は必ず `physics-constants.ts` からimport

### DB層（`src/db/`）
- Dexie.js（IndexedDB）でセーブデータを永続化
- `save-load.ts` がセーブ/ロードAPIを提供

### ストア層（`src/store/`）
- Zustandでグローバル状態管理
- DB層経由でセーブ/ロード
- エンジン関数をラップしてアクションとして公開

### UI層（`src/app/`）
- 全ページ `"use client"` （ゲームなのでSSR不要）
- Tailwind CSSでスタイリング

## コーディング規約

- UIテキスト・コメントは日本語
- 数値表示: `tabular-nums` + 右寄せ (`text-right`)
- 色使い: 自チーム=`text-blue-400`、勝=blue、敗=red、引分=gray
- 能力値の色分け: 80+=gold(`text-yellow-400`)、65+=green、50+=white、35+=orange、<35=red
- テーブル: ストライプ(`even:bg-gray-800`) + ホバー(`hover:bg-gray-700`)
- 背景: `bg-gray-900`, テキスト: `text-white`
- 型にフィールド追加時は**必ずoptional** (`?:`) + 使用箇所で `?? デフォルト値`
- マジックナンバー禁止（`physics-constants.ts`に定数化）
- 不要なコメント・docstring・過剰な抽象化は避ける
- スケジュール: NPB準拠143試合制（同リーグ25×5=125 + 交流戦3×6=18）
- 成績指標の定義・計算式は `docs/baseball-knowledge.md` を参照
- 実装パターンは `docs/patterns.md` を参照
- 指標の参考: https://1point02.jp/op/gnav/glossary/gls_index.aspx?cp=101

## ドキュメント体系

| ファイル | 役割 | いつ参照 |
|---|---|---|
| `CLAUDE.md` | プロジェクトの知識・ルール | 常時（自動読込） |
| `task.md` | タスク一覧・完了条件・優先度 | タスク選定時 |
| `GAME_SPEC.md` | ゲームルール・数値設計の仕様 | 実装時・監査時 |
| `docs/baseball-knowledge.md` | 野球ドメイン知識・NPBベンチマーク | 設計時・バランス検証時 |
| `docs/patterns.md` | 実装パターン・アンチパターン | 実装開始前 |
| `docs/design-decisions.md` | 過去の設計判断・バランス調整履歴 | 関連機能の修正時 |
| `docs/autonomous-workflow.md` | 自律開発の詳細手順・ReActループ | 自律モード実行時 |
| `docs/workflow.md` | 開発ワークフロー詳細（スプリント・3タブ運用等） | 運用手順の確認時 |
| `docs/lessons.md` | 教訓・学習記録（修正指摘のパターン蓄積） | セッション開始時・ミス発生時 |
| `docs/fielding-distribution-analysis.md` | 守備機会分布のNPB実データ分析 | 守備ロジック修正時 |
| `docs/testing-strategy.md` | テスト戦略・レイヤー別ガイド・既存テスト一覧 | テスト追加・修正時 |

`GAME_SPEC.md` はゲームバランスに関わる実装を行う際に必ず参照する。
確率・計算式・パラメータを変更した場合は、コードと仕様書を同時に更新する。

## チーム体制（サブエージェント）

PMが専門エージェントに作業を委譲する。定義ファイルは `.claude/agents/` にある。

| 役割 | エージェント名 | モデル | 担当領域 |
|---|---|---|---|
| PM（あなた自身） | メインセッション | opus | 全体統括・タスク分解・Git操作 |
| エンジン実装くん | `impl-engine` | sonnet | engine/ (simulation/fielding-ai/physics/season等) |
| UI実装くん | `impl-ui` | sonnet | app/game/[id]/ 全ページ・components/ |
| データ実装くん | `impl-data` | sonnet | models/・store/・db/・GAME_SPEC/docs |
| 汎用実装くん | `implementer` | sonnet | 領域横断・小規模修正（フォールバック） |
| テストくん | `tester` | haiku | 動作検証（読み取り専用） |
| レビューくん | `reviewer` | sonnet | コードレビュー（編集不可） |
| ガーディアン | `guardian` | sonnet | 品質監査（編集不可） |

### ワークフロー

```
1. PM: task.md を読み、タスクを分解
2. PM → 適切な実装くん: 領域に応じて委譲
3. 実装くん: コード実装 → npm run build → 結果を返す
4. [自動] hook: build + lint チェック
5. PM → ガーディアン: 品質監査（大きい変更時）
6. PM: git commit → push origin → task.md 更新
```

### 運用ルール
- テストくん・レビューくん・ガーディアンはコードを編集しない（指摘のみ）
- 異なる領域の実装くんは並列委譲OK（例: impl-engine + impl-ui）
- `models/player.ts` `store/game-store.ts` を触るタスクは他と並列にしない
- ガーディアンはシミュレーション変更・型変更・大きな機能追加時に呼ぶ
- コミットメッセージは日本語で変更内容を要約
- **コミット後は自動で `git push origin` まで行う**（確認不要）
- force-pushは使わない

### 自動化（Hooks）
- **Edit/Write後**: 自動で `npm run build` → 失敗時はClaudeに通知され自動修正
- **実装くん完了後**: 自動で build + lint チェック

### 自律パイプライン（バックグラウンド実行）
`自律: YES` タスクは impl → tester → reviewer → commit の順で自動実行。
詳細は `docs/autonomous-workflow.md` を参照。

## 進捗の可視化ルール

- **すべての進捗表示・報告は日本語で行う**
  - TaskCreate の subject / activeForm は日本語（例: subject「エラー率をスキル依存に変更」、activeForm「エラー率修正中…」）
  - サブエージェントへの Task の description も冒頭に日本語で要約を入れる
- 複数ステップの作業は必ず TaskCreate で進捗追跡
- **大きいタスクは5-10分単位のサブタスクに分割**してTaskCreateで個別追跡する
- サブタスク開始時に `in_progress`、完了時に `completed` を即反映
- サブエージェント委譲**前**に「○○を実装くんに任せます」と報告
- バックグラウンド委譲時は「今○○をやっている」を日本語で明示
- **バックグラウンドエージェントは2分間隔で進捗チェック**を入れ、状況をユーザーに報告する
- ビルドエラーやテスト失敗でループしそうなら即座に状況を報告。黙ってリトライしない

## task.md の運用

- 人間: タスク追加・優先度決定・提案の承認/却下
- PM: 完了マーク・発見タスクの追記（`## PMからの提案`セクション）・CLAUDE.md更新
- PMは正式タスクを勝手に追加・削除しない（提案のみ）

## 自律開発モード

`task.md` の `自律: YES` タスクを人間の指示なしに実行できる。
詳細な手順は `docs/autonomous-workflow.md` を参照。

### 自律判断のルール

| 自律OK | 人間確認が必要 |
|---|---|
| `自律: YES` + 完了条件付きタスク | 新しいUIページの追加 |
| バグ修正（既存動作の回帰） | モデル型の大幅変更（5フィールド以上） |
| バランス調整（NPB準拠範囲が明確） | ゲームルールの新規追加 |
| ドキュメントの実態同期 | ゲームデザイン判断 |

### 暴走防止ルール
1. 完了条件のないタスクは着手しない
2. 迷ったらスキップして次へ
3. 1タスク1コミット（巨大な変更にならないよう分割）
4. ビルドエラー3回リトライで解決しなければ**即停止→原因分析→再プラン**（同じ修正をリトライしない）
5. ガーディアン差し戻し2回で人間に報告して中断
6. 問題発生時は無理に進めず、立ち止まって別のアプローチを検討する

### 破壊的操作の禁止・安全ルール

**禁止（絶対に実行しない）:**
- `git push --force` / `git push -f`（`--force-with-lease` も禁止）
- `git reset --hard` / `git checkout -- .` / `git restore .` / `git clean -f`（未コミット作業の全消失）
- プロジェクト外パスへの `rm -rf`・書き込み
- `kill` / `killall` / `pkill`（他プロセスの停止）

**一時停止して報告（PMに確認）:**
- 10ファイル以上の一括削除
- プロジェクト外ファイルの変更
- 大量ファイル変更時はバッチ1（最初の1-2ファイル）で品質確認してから残りを実行

**安全なデフォルト:**
- ファイルは Read してから Edit/Write（未読ファイルの編集禁止）
- `rm` の前に対象パスを確認（`ls` で存在確認）
- `git stash` → `git reset` の順で安全に巻き戻し
- `git clean -n`（ドライラン）→ 確認 → `git clean -f`

### プランモード活用
- 3ステップ以上、または設計判断を含むタスクは必ずプランモードに入る
- 曖昧さがあれば、実装前に詳細な仕様を書き出す
- プラン→実装→検証のサイクルを守る

### 自己改善ループ
- ユーザーから修正・指摘を受けたら `docs/lessons.md` にパターンを追記する
- 同じミスを繰り返さないルールを自分で作る
- セッション開始時に関連する教訓を見直す

### 完了前チェック
- 動作確認なしに完了扱いにしない
- 「スタッフエンジニアが承認するか？」と自問する
- テスト実行・ログ確認・mainとの差分確認を行う

## セッション開始時の振る舞い

新しいセッションを開始したら、最初に自分の役割を宣言する:

```
PMセッション（デフォルト）:
  「PM担当です。/sprint で現在のスプリント状況を確認できます。」

実装セッション（ユーザーが実装指示を出した場合）:
  「実装担当です。[タスク名] に着手します。」
  → 完了条件を確認してから作業開始
```

判断基準:
- ユーザーの最初のメッセージが設計・相談・管理系 → PM
- ユーザーの最初のメッセージが具体的な実装指示 → 実装担当
- 不明な場合 → PM（デフォルト）

## 開発ワークフロー

タスク規模で実行方法を選ぶ:
- **小** (数行〜30行): PMタブで直接実装
- **中** (30〜100行): `/delegate` でサブエージェントに委譲
- **大** (100行+): 別タブに指示を投入

スプリント制(2-3日サイクル)で運用。コマンド: `/sprint`, `/sprint plan`, `/sprint done`, `/delegate`, `/review`

詳細（3タブ運用・指示テンプレート・役割分担・判断ルール）は `docs/workflow.md` を参照。

## 既知の問題

- **投手守備機会が少ない**: バント実装済みだが頻度がまだ低い可能性あり
- **フライボール安打率がやや高め(~20%)**: NPB標準(~15%)より高い。外野手デフォルト位置調整で改善可能
