# ゲーム仕様書 - Baseball GM

コードから読み取りにくいゲームルール・数値設計をまとめたドキュメント。
PMはこのファイルを参照して、ゲームバランスに影響する実装を行う。

---

## 能力値体系

### 野手能力（1〜100）
| 能力 | 英名 | 影響 |
|---|---|---|
| ミート | contact | 安打確率に直結 |
| パワー | power | 長打率・本塁打率に影響 |
| 走力 | speed | 三塁打率に影響（盗塁は未実装） |
| 守備力 | fielding | 現在シミュレーション未使用 |
| 選球眼 | eye | 四球率に影響 |

### 投手能力（1〜100）
| 能力 | 英名 | 影響 |
|---|---|---|
| 球速 | velocity | 奪三振率に影響 |
| 制球 | control | 四球率の抑制、被安打率の抑制 |
| 変化球 | breaking | 被安打率の抑制 |
| スタミナ | stamina | 現在シミュレーション未使用（完投固定） |
| 精神力 | mentalToughness | 現在シミュレーション未使用 |

### 潜在能力（ポテンシャル）
| グレード | 出現率 | トレード価値倍率 |
|---|---|---|
| S | 5% | ×1.5 |
| A | 10% | ×1.3 |
| B | 25% | ×1.1 |
| C | 30% | ×1.0 |
| D | 30% | ×0.9 |

---

## 試合シミュレーション

### 打席の判定フロー

```
打席開始
  ↓
死球判定 → 死球なら出塁
  ↓
四球判定 → 四球なら出塁
  ↓
三振判定 → 三振ならアウト
  ↓
インプレー → 打球物理エンジンへ
  ↓
打球生成 (方向・角度・速度) → 打球タイプ分類
  ↓
着地座標計算 (calcBallLanding)
  ↓
守備AI判定 (evaluateFielders: 9人の到達時間計算)
  ↓
結果判定 (resolvePlayWithAI: 物理ベースの安打/アウト判定)
```

### 確率計算式（打席結果判定）

```
contactFactor  = (batter.contact - breakingPower * 0.5) / 100
eyeFactor      = (batter.eye - pitcher.control * 0.3) / 100
velocityFactor = (velocity - 120) / 45
controlFactor  = pitcher.control / 100
```

| 結果 | 確率 | 最低保証 |
|---|---|---|
| 死球 | 0.008 + (1 - controlFactor) × 0.007 | 0.3% |
| 四球 | 0.075 + eyeFactor × 0.05 - controlFactor × 0.04 | 2% |
| 三振 | 0.14 + velocityFactor × 0.08 - contactFactor × 0.06 + finisherBonus | 5% |
| インプレー | 残りの確率 | - |

### 打球物理エンジン

インプレー時に打球の物理データ（方向・角度・速度）を生成し、ゾーンベースでフィールダーを決定する。

#### BattedBall（打球データ）
| プロパティ | 範囲 | 説明 |
|---|---|---|
| direction | 0°〜90° | 打球方向（0=レフト線, 45=センター, 90=ライト線） |
| launchAngle | -15°〜70° | 打球角度（負=ゴロ, 10-20=ライナー, 20-50=フライ, 50+=ポップ） |
| exitVelocity | 80〜185 km/h | 打球速度 |
| type | BattedBallType | 後方互換用の分類 |

#### 打球方向の生成
```
基本: 右打者=38°, 左打者=52°, 両打ち=45°
プル補正: (power - 50) × 0.08 (パワーが高いとプル傾向が強まる)
分布: ガウス乱数 (σ=18°)
```

#### 打球角度の生成
```
基本: 12° + (power - 50) × 0.08 - (contact - 50) × 0.04
シンカーボーナス: sinker.level × 0.6 + shoot.level × 0.4 (最大5°低下)
分布: ガウス乱数 (σ=16°)
```

#### 打球速度の生成
```
基本: 120 + (power - 50) × 0.5 + (contact - 50) × 0.15
変化球ペナルティ: (breakingPower - 50) × 0.15
分布: ガウス乱数 (σ=18 km/h)
```

#### 打球タイプ分類
| 条件 | 分類 |
|---|---|
| launchAngle ≥ 50° | popup |
| launchAngle < 10° | ground_ball |
| 10° ≤ launchAngle < 15° かつ exitVelocity < 100 | ground_ball |
| 10° ≤ launchAngle < 20° | line_drive |
| 20° ≤ launchAngle < 50° | fly_ball |

#### 守備AI (fielding-ai.ts)

**座標系**: フィールド上の2D座標 (メートル)
- x: 左右 (正=1塁側, 負=3塁側)
- y: 前後 (0=ホーム, 正=外野方向)

**デフォルト守備位置**:
| Pos | x | y |
|---|---|---|
| P | 0 | 18.4 |
| C | 0 | 1.0 |
| 1B | 20 | 28 |
| 2B | 10 | 36 |
| 3B | -20 | 28 |
| SS | -10 | 36 |
| LF | -26 | 65 |
| CF | 0 | 73 |
| RF | 26 | 65 |

**着地座標計算** (`calcBallLanding`):
- ゴロ: 摩擦減速モデル (最大55m), `distance = min(55, v0 * 1.2)`
- フライ/ライナー: 放物運動 + 空気抵抗補正 (dragFactor=0.60)

**守備判断** (`evaluateFielders`): 全9野手の到達時間を計算
- 反応時間: 0.3-0.6s (ライナーは+0.3-0.5sの追加遅延)
- 走力: 5.0-8.0 m/s (batting.speed依存)
- ゴロ: ボール経路への垂直距離で判定 (経路上のパス通過時間比較)
- フライ/ライナー: 着地位置への直線距離で判定

#### 本塁打判定 (飛距離ベース)
```
推定飛距離: 放物運動 × dragFactor(0.60)
フェンス距離: 100 + 22 × sin(direction × π / 90) (両翼100m, 中堅122m)
ratio = 飛距離 / フェンス距離
ratio ≥ 1.05 → HR確定
0.95 ≤ ratio < 1.05 → フェンス際ランダム (パワー補正付き)
ratio < 0.95 → HR不可
```

#### インプレー結果判定 (物理ベース)

**ゴロ**:
1. 野手がボール経路に到達 → 捕球 (97-99.5%成功)
2. 捕球後: 確保(0.3-0.6s) + 持ち替え(0.6-1.0s) + 送球 → 走者との競争
3. 走者が先着 → 内野安打 / 送球が先着 → アウト (併殺/FC判定あり)
4. 到達不可 → 外野手回収 → ヒット (進塁判定で単打/長打)

**フライ/ライナー**:
1. 野手が着地前に到達 → 捕球試行 (85-99%成功, 余裕度依存)
2. 到達不可 → ヒット → 回収+送球 vs 走者で長打判定

**長打判定** (物理ベース):
- ヒット確定後、ボールの着地後バウンド・ロールを計算
- バウンスペナルティ: 着地距離に応じた回収遅延 (1.4-4.4s, 深いほど大きい)
- フェンス際 (距離≥フェンスの90%): 壁リバウンドで追加 +0.6-1.2s
- ゴロ抜け: 比較的予測しやすい (0.5-1.0s)
- 回収位置から各塁への送球時間 vs 走者の塁到達時間を比較
- 走者が先にセーフなら次の塁へ進塁 → 単打/二塁打/三塁打が自然に決まる
- 3Bへの進塁はリスクが高いため、1.5秒以上の余裕が必要
- 送球速度: 25-40 m/s (arm依存), 走者速度: 6.5-9.0 m/s (speed依存)

### 走塁ルール

| 打撃結果 | 1塁走者 | 2塁走者 | 3塁走者 |
|---|---|---|---|
| 単打/エラー | → 2塁 | → 3塁 | → 生還 |
| 二塁打 | → 3塁 | → 生還 | → 生還 |
| 三塁打 | → 生還 | → 生還 | → 生還 |
| 本塁打 | → 生還 | → 生還 | → 生還 |
| 四球 | → 2塁（押し出し） | → 3塁（満塁時） | → 生還（満塁時） |
| 凡打 | 動かない | 動かない | 動かない |

### 試合進行
- 9回制、同点なら延長12回まで
- 12回終了時同点 → 引き分け
- 9回裏ホームチームリードなら打ち切り
- 先発投手が完投（リリーフ未実装）
- 打順は contact + power + speed 上位9人で自動決定

---

## シーズン構成（NPB準拠 143試合制）

### 日程
| 期間 | 内容 | 日数 |
|---|---|---|
| 前半リーグ戦 | 同リーグ対戦 | 60日 |
| 交流戦 | セパ対抗 | 18日 |
| 後半リーグ戦 | 同リーグ対戦 | 65日 |
| **合計** | | **143日** |

### 試合数
- 同リーグ: 5チーム × 25試合 = 125試合
- 交流戦: 6チーム × 3試合 = 18試合
- 合計: 143試合/チーム、858試合エントリ
- 1日6試合（セ3 + パ3）

### シーズンフェーズ
```
preseason → regular_season → (playoffs: 未実装) → offseason
```

---

## ドラフト

- ウェーバー方式（前年成績下位から指名）
- 5巡、1巡あたり12チーム = 60指名
- 候補者プール: 110人（60 + 余剰50人）
- 候補年齢: 18〜22歳、能力値: 25〜65

### CPU指名ロジック
- 投手: velocity + control + breaking の合計が最大の候補
- 野手: contact + power + speed の合計が最大の候補
- ポジション需要は考慮しない（改善候補）

---

## トレード

### 選手価値の算出

**投手:**
```
value = velocity × 1.2 + control × 1.0 + breaking × 1.1
        + stamina × 0.5 + mentalToughness × 0.3
```

**野手:**
```
value = contact × 1.0 + power × 1.2 + speed × 0.6
        + fielding × 0.4 + eye × 0.8
```

### 年齢補正
| 年齢 | 倍率 |
|---|---|
| 〜25歳 | ×1.3（若手プレミアム） |
| 26〜30歳 | ×1.0（基準値） |
| 31〜33歳 | ×0.7（衰え） |
| 34歳〜 | ×0.4（ベテラン割引） |

### CPU交渉ロジック
```
受諾条件: 提供選手の合計価値 ≥ 要求選手の合計価値 × 0.9
```
CPUは10%の割引で交渉に応じる。

---

## 選手生成

### ロスター構成（1チーム25人）
- 投手11人 + 野手14人

### 生成パラメータ
| 項目 | 範囲 |
|---|---|
| 年齢 | 18〜36歳 |
| 能力基本値 | 30〜75 |
| 能力振れ幅 | 基本値 ± 15（守備・精神は ± 10） |
| 投手生成率 | 35% |

### 年俸計算
```
baseSalary = (overall × 10 + random(-100, 300)) × ageMultiplier
ageMultiplier = 1.0 (30歳以下) / 1.3 (31歳以上)
```
単位: 万円。契約年数: 1〜4年ランダム。

---

## 12チーム一覧

### セントラル・リーグ
| ID | チーム名 | 略称 | カラー | 本拠地 |
|---|---|---|---|---|
| tokyo-eagles | 東京イーグルス | 東京 | 赤 | 東京ドーム |
| yokohama-stars | 横浜スターズ | 横浜 | 青 | 横浜スタジアム |
| nagoya-dragons | 名古屋ドラゴンズ | 名古屋 | 紺 | ナゴヤドーム |
| osaka-tigers | 大阪タイガース | 大阪 | 黄 | 甲子園球場 |
| hiroshima-reds | 広島レッズ | 広島 | 赤 | マツダスタジアム |
| sendai-swallows | 仙台スワローズ | 仙台 | 緑 | 仙台球場 |

### パシフィック・リーグ
| ID | チーム名 | 略称 | カラー | 本拠地 |
|---|---|---|---|---|
| fukuoka-hawks | 福岡ホークス | 福岡 | 琥珀 | 福岡PayPayドーム |
| sapporo-fighters | 札幌ファイターズ | 札幌 | 紺 | エスコンフィールド |
| chiba-marines | 千葉マリーンズ | 千葉 | 黒 | ZOZOマリンスタジアム |
| saitama-lions | 埼玉ライオンズ | 埼玉 | 青 | ベルーナドーム |
| kobe-buffaloes | 神戸バファローズ | 神戸 | 紫 | 京セラドーム |
| tohoku-golden | 東北ゴールデンズ | 東北 | 臙脂 | 楽天モバイルパーク |

---

## 未実装機能（コードに痕跡あり）

| 機能 | 現状 |
|---|---|
| 盗塁 | statsに項目あるがシミュレーション未使用 |
| セーブ | savePitcherId常にnull |
| ホールド | statsに項目あるがインクリメントなし |
| リリーフ投手 | 先発が完投。スタミナ未使用 |
| プレーオフ | フェーズは定義済みだがスケジュール生成なし |
| 守備力 | 能力値あるがシミュレーション未使用 |
| 精神力 | 能力値あるがシミュレーション未使用 |
| 打順設定 | 能力値合計で自動決定、手動設定不可 |
