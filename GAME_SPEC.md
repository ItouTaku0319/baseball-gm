# ゲーム仕様書 - Baseball GM

コードから読み取りにくいゲームルール・数値設計をまとめたドキュメント。
PMはこのファイルを参照して、ゲームバランスに影響する実装を行う。

---

## 能力値体系

### 野手能力（1〜100）
| 能力 | 英名 | 影響 |
|---|---|---|
| ミート | contact | 安打確率に直結 |
| パワー | power | 長打率・本塁打率に影響 |
| 走力 | speed | 三塁打率・盗塁・内野安打に影響 |
| 守備力 | fielding | 守備AI（到達速度・捕球率）に影響 |
| 選球眼 | eye | 四球率に影響 |

### 投手能力（1〜100）
| 能力 | 英名 | 影響 |
|---|---|---|
| 球速 | velocity | 奪三振率に影響 |
| 制球 | control | 四球率の抑制、被安打率の抑制 |
| 変化球 | breaking | 被安打率の抑制 |
| スタミナ | stamina | 投球ごとに消費、50%以下で疲労ペナルティ |
| 精神力 | mentalToughness | ピンチ時の制球安定（得点圏±5）、疲労ペナルティ軽減（最大30%） |

### 潜在能力（ポテンシャル）
| グレード | 出現率 | トレード価値倍率 |
|---|---|---|
| S | 5% | ×1.5 |
| A | 10% | ×1.3 |
| B | 25% | ×1.1 |
| C | 30% | ×1.0 |
| D | 30% | ×0.9 |

---

## 試合シミュレーション

### 打席の判定フロー

```
打席開始
  ↓
犠牲バント判定 → 条件を満たす場合: 成功(sacrifice_bunt)→走者進塁+打者アウト / 失敗(bunt_out)→打者アウト
  ↓
セーフティバント判定 → 走力80以上で低確率試行: 成功(bunt_hit)→打者出塁 / 失敗(bunt_out)→打者アウト
  ↓
死球判定 → 死球なら出塁
  ↓
四球判定 → 四球なら出塁
  ↓
三振判定 → 三振ならアウト
  ↓
インプレー → 打球物理エンジンへ
  ↓
打球生成 (方向・角度・速度) → 打球タイプ分類
  ↓
着地座標計算 (calcBallLanding)
  ↓
守備AI判定 (evaluateFielders: 9人の到達時間計算)
  ↓
結果判定 (resolvePlayWithAI: 物理ベースの安打/アウト判定)
```

### バント判定フロー

#### 犠牲バント試行条件
- 走者が1塁または2塁にいる
- 0アウトまたは1アウト
- 投手(isPitcher=true)、または打順7〜9番かつミート50未満

#### 犠牲バント成功率
```
successRate = 0.60 + batter.contact × 0.002
// contact 50 → 70%, contact 100 → 80%
```

| 結果 | 確率 | 処理 |
|---|---|---|
| 成功 (sacrifice_bunt) | successRate | 打者アウト、走者1塁進塁 |
| ゴロアウト (bunt_out) | (1-successRate)×40% | 打者アウト、走者進塁なし |
| ゴロアウト (bunt_out) | (1-successRate)×40% | 打者アウト |
| フィルダースチョイス (bunt_out) | (1-successRate)×20% | 打者1塁、走者アウト |

ファウル時は最大2回まで再試行。3回目は通常打席へ移行。

守備記録: 投手(1)にA(補殺)、一塁手(3)にPO(刺殺)

#### セーフティバント試行条件
- 走力(speed) ≥ 85
- 試行確率: `0.01 + (speed - 85) × 0.0005`（1〜2%）

#### セーフティバント成功率
```
successRate = 0.20 + speed × 0.002 + contact × 0.001
// speed 85, contact 50 → 42%
```

### 確率計算式（打席結果判定）

```
contactFactor  = (batter.contact - breakingPower * 0.5) / 100
eyeFactor      = (batter.eye - pitcher.control * 0.3) / 100
velocityFactor = (velocity - 120) / 45
controlFactor  = pitcher.control / 100
```

| 結果 | 確率 | 最低保証 |
|---|---|---|
| 死球 | 0.008 + (1 - controlFactor) × 0.007 | 0.3% |
| 四球 | 0.075 + eyeFactor × 0.05 - controlFactor × 0.04 | 2% |
| 三振 | 0.20 + velocityFactor × 0.08 - contactFactor × 0.10 + finisherBonus | 5% |
| インプレー | 残りの確率 | - |

### 打球物理エンジン

インプレー時に打球の物理データ（方向・角度・速度）を生成し、ゾーンベースでフィールダーを決定する。

#### BattedBall（打球データ）
| プロパティ | 範囲 | 説明 |
|---|---|---|
| direction | 0°〜90° | 打球方向（0=レフト線, 45=センター, 90=ライト線） |
| launchAngle | -15°〜70° | 打球角度（負=ゴロ, 10-20=ライナー, 20-50=フライ, 50+=ポップ） |
| exitVelocity | 80〜185 km/h | 打球速度 |
| type | BattedBallType | 後方互換用の分類 |

#### 打球方向の生成
```
基本: 右打者=38°, 左打者=52°, 両打ち=45°
プル補正: (power - 50) × 0.08 (パワーが高いとプル傾向が強まる)
分布: ガウス乱数 (σ=18°)
```

#### 打球角度の生成
```
基本: 12° + (power - 50) × 0.08 - (contact - 50) × 0.04
シンカーボーナス: sinker.level × 0.6 + shoot.level × 0.4 (最大5°低下)
分布: ガウス乱数 (σ=16°)
```

#### 打球速度の生成
```
基本: 132 + (power - 50) × 0.15 + (contact - 50) × 0.15
変化球ペナルティ: (breakingPower - 50) × 0.15
分布: ガウス乱数 (σ=18 km/h), 範囲: [80, 170]
```

#### 打球タイプ分類
| 条件 | 分類 |
|---|---|
| launchAngle ≥ 50° | popup |
| launchAngle < 10° | ground_ball |
| 10° ≤ launchAngle < 15° かつ exitVelocity < 100 | ground_ball |
| 10° ≤ launchAngle < 20° | line_drive |
| 20° ≤ launchAngle < 50° | fly_ball |

#### 守備AI (fielding-ai.ts)

**座標系**: フィールド上の2D座標 (メートル)
- x: 左右 (正=1塁側, 負=3塁側)
- y: 前後 (0=ホーム, 正=外野方向)

**デフォルト守備位置**:
| Pos | x | y |
|---|---|---|
| P | 0 | 18.4 |
| C | 0 | 1.0 |
| 1B | 20 | 28 |
| 2B | 10 | 36 |
| 3B | -20 | 28 |
| SS | -10 | 36 |
| LF | -26 | 65 |
| CF | 0 | 73 |
| RF | 26 | 65 |

**着地座標計算** (`calcBallLanding`):
- ゴロ: 摩擦減速モデル (最大55m), `distance = min(55, v0 * 1.2)`
- フライ/ライナー: 放物運動 + 空気抵抗補正 (FLIGHT_TIME_FACTOR=0.85, DRAG_FACTOR=0.63)

**守備判断** (`evaluateFielders`): 全9野手の到達時間を計算
- 反応時間: 0.3-0.6s (ライナーは+0.3-0.5sの追加遅延)
- 走力: 5.0-8.0 m/s (batting.speed依存)
- ゴロ: ボール経路への垂直距離で判定 (経路上のパス通過時間比較)
- フライ/ライナー: 着地位置への直線距離で判定

**守備力(fielding)の影響**:
- 反応時間にfielding値で補正 (100で最短0.3s、1で最長0.6s)
- ゴロ捕球成功率にfielding値で補正（97-99.5%の範囲内）
- フライ捕球成功率にfielding/catching値で補正（90-99%の範囲内）

#### 本塁打判定 (飛距離ベース)
```
推定飛距離: estimateDistance() — calcBallLandingと同一の物理式
  tUp = vy0 / g, maxH = h + vy0²/(2g), tDown = √(2*maxH/g)
  flightTime = (tUp + tDown) × FLIGHT_TIME_FACTOR(0.85)
  distance = vx × flightTime × DRAG_FACTOR(0.63)
  ※全定数はphysics-constants.tsで一元管理

フェンス距離: FENCE_BASE(95) + FENCE_CENTER_EXTRA(23) × sin(dir × π / 90)  ※甲子園球場準拠
フェンス高さ: FENCE_HEIGHT(4.0m)

弾道キャリーファクター: [1.07, 1.19, 1.25, 1.30] (弾道1-4)
  弾道1: +7%
  弾道2: +19% (基準)
  弾道3: +25%
  弾道4: +30% (フライ打ちタイプは最大飛距離が出る)

effectiveDistance = 飛距離 × trajectoryCarryFactor
ratio = effectiveDistance / フェンス距離

急角度キャリー減衰: 35°以下=フルキャリー、35-50°=線形減衰、50°以上=キャリー無し
  taper = max(0, 1 - (angle - 35) / 15)
  trajectoryCarryFactor = 1 + (baseCarry - 1) × taper
  ※バックスピン揚力は急角度で水平成分に効きにくい物理現象をモデル化

HR判定 (fly_ball / popup 共通, 2条件):
  1. ratio ≥ 1.0 (水平距離がフェンスに到達)
  2. フェンス水平距離到達時の打球高さ ≥ FENCE_HEIGHT
     gEff = g / carryFactor (バックスピン揚力を実効重力軽減でモデル化)
     tUp = vy0 / gEff, maxH = BAT_HEIGHT + vy0²/(2gEff), tDown = √(2maxH/gEff)
     tFence = (fenceDist / effectiveDistance) × (tUp + tDown)
     heightAtFence = BAT_HEIGHT + vy0 × tFence - 0.5 × gEff × tFence²
  両条件を満たす → HR確定
  距離は足りるが高さ不足 → フェンス直撃（通常のフライとして守備処理）
  ポップフライ(≥38°)でHR条件を満たさない → 常にアウト（popout）

※ AtBatLogのestimatedDistanceはフライ/ポップフライ打球にcarryFactor適用済みの値を記録
```

#### インプレー結果判定 (物理ベース)

**ゴロ**:
1. 野手がボール経路に到達 → 捕球 (97-99.5%成功)
2. 捕球後: 確保(0.3-0.6s) + 持ち替え(0.6-1.0s) + 送球 → 走者との競争
3. 走者が先着 → 内野安打 / 送球が先着 → アウト (併殺/FC判定あり)
4. 到達不可 → 外野手回収 → ヒット (進塁判定で単打/長打)

**フライ/ライナー**:
1. 野手が着地前に到達 → 捕球試行 (85-99%成功, 余裕度依存)
2. 到達不可 → ヒット → 回収+送球 vs 走者で長打判定

**長打判定** (物理ベース):
- ヒット確定後、ボールの着地後バウンド・ロールを計算
- バウンスペナルティ: 着地距離に応じた回収遅延 (1.4-4.4s, 深いほど大きい)
- フェンス際 (距離≥フェンスの90%): 壁リバウンドで追加 +0.6-1.2s
- ゴロ抜け: 比較的予測しやすい (0.5-1.0s)
- 回収位置から各塁への送球時間 vs 走者の塁到達時間を比較
- 走者が先にセーフなら次の塁へ進塁 → 単打/二塁打/三塁打が自然に決まる
- 3Bへの進塁はリスクが高いため、1.5秒以上の余裕が必要
- 送球速度: 25-40 m/s (arm依存), 走者速度: 6.5-9.0 m/s (speed依存)

### 走塁ルール

| 打撃結果 | 1塁走者 | 2塁走者 | 3塁走者 |
|---|---|---|---|
| 単打/エラー | → 2塁 | → 3塁 | → 生還 |
| 二塁打 | → 3塁 | → 生還 | → 生還 |
| 三塁打 | → 生還 | → 生還 | → 生還 |
| 本塁打 | → 生還 | → 生還 | → 生還 |
| 四球 | → 2塁（押し出し） | → 3塁（満塁時） | → 生還（満塁時） |
| 凡打 | 動かない | 動かない | 動かない |

### 試合進行
- 9回制、同点なら延長12回まで
- 12回終了時同点 → 引き分け
- 9回裏ホームチームリードなら打ち切り
- 打順は contact + power + speed 上位9人で自動決定

### 投手起用
- **先発ローテーション**: 最大6人、スタミナ重視でスコア順に自動選出
- **リリーフ投手**: 最大8人、球速・変化球重視でスコア順に自動選出
- **先発起用方針**: 6種（complete_game / win_eligible / performance / stamina_save / opener / short_starter）
- **リリーフ起用方針**: 5種（closer / lead_only / close_game / behind_ok / mop_up）

#### リリーフ役割と最大イニング（デフォルト）
| 順位 | 役割 | maxInnings | 説明 |
|------|------|-----------|------|
| 1位 | closer | 1 | 9回リード時に登板 |
| 2-3位 | close_game | 1 | 8回リード時に登板 |
| 4-6位 | behind_ok | 1 | 5-7回、ビハインド時に登板 |
| 7-8位 | mop_up | 1 | 大量ビハインド/リード時に登板 |

#### 連投制限
- 4連投以上 → 登板不可
- 同じ役割の投手が複数いる場合、連投日数が少ない投手を優先選択（負荷分散）
- 全リリーフが連投制限で使用不可 → 最も連投日数が少ない投手を選択（フォールバック）
- 連投状態は試合ごとに更新（登板→+1、非登板→リセット）

#### 投手交代判定
- **イニング間**: starterUsagePolicyに応じたスタミナ・自責点ベース
- **イニング途中**: maxInnings到達、3失点以上+1アウト以下、満塁+0アウト+スタミナ30%以下、スタミナ10%以下

#### NPBベンチマーク（600試合検証結果）
| 指標 | 結果 | NPB目安 |
|------|------|---------|
| 投手交代/試合 | 4.2 | 3-5 |
| 先発平均IP | 5.3 | 5.5-6.5 |
| リリーフ平均IP/登板 | 0.85 | 0.8-1.5 |
| QS率 | 51% | 40-55% |
| 最多リリーフ登板/143試合 | ~104 | 60-75 (※) |
| 最多リリーフIP/143試合 | ~94 | <80 (※) |
| 規定投球回超えリリーフ | 0人 | 0人 |

※ シミュレーションにオフデーがないため、NPB実データより高めになる

---

## シーズン構成（NPB準拠 143試合制）

### 日程
| 期間 | 内容 | 日数 |
|---|---|---|
| 前半リーグ戦 | 同リーグ対戦 | 60日 |
| 交流戦 | セパ対抗 | 18日 |
| 後半リーグ戦 | 同リーグ対戦 | 65日 |
| **合計** | | **143日** |

### 試合数
- 同リーグ: 5チーム × 25試合 = 125試合
- 交流戦: 6チーム × 3試合 = 18試合
- 合計: 143試合/チーム、858試合エントリ
- 1日6試合（セ3 + パ3）

### シーズンフェーズ
```
preseason → regular_season → playoffs (CS + 日本シリーズ) → offseason
```

---

## ドラフト

- ウェーバー方式（前年成績下位から指名）
- 5巡、1巡あたり12チーム = 60指名
- 候補者プール: 110人（60 + 余剰50人）
- 候補年齢: 18〜22歳、能力値: 25〜65

### CPU指名ロジック
- 投手: velocity + control + breaking の合計が最大の候補
- 野手: contact + power + speed の合計が最大の候補
- ポジション需要は考慮しない（改善候補）

---

## トレード

### 選手価値の算出

**投手:**
```
value = velocity × 1.2 + control × 1.0 + breaking × 1.1
        + stamina × 0.5 + mentalToughness × 0.3
```

**野手:**
```
value = contact × 1.0 + power × 1.2 + speed × 0.6
        + fielding × 0.4 + eye × 0.8
```

### 年齢補正
| 年齢 | 倍率 |
|---|---|
| 〜25歳 | ×1.3（若手プレミアム） |
| 26〜30歳 | ×1.0（基準値） |
| 31〜33歳 | ×0.7（衰え） |
| 34歳〜 | ×0.4（ベテラン割引） |

### CPU交渉ロジック
```
受諾条件: 提供選手の合計価値 ≥ 要求選手の合計価値 × 0.9
```
CPUは10%の割引で交渉に応じる。

---

## 選手生成

### ロスター構成（1チーム25人）
- 投手11人 + 野手14人

### 生成パラメータ
| 項目 | 範囲 |
|---|---|
| 年齢 | 18〜36歳 |
| 能力基本値 | 30〜75 |
| 能力振れ幅 | 基本値 ± 15（守備・精神は ± 10） |
| 投手生成率 | 35% |

### 年俸計算
```
baseSalary = (overall × 10 + random(-100, 300)) × ageMultiplier
ageMultiplier = 1.0 (30歳以下) / 1.3 (31歳以上)
```
単位: 万円。契約年数: 1〜4年ランダム。

---

## 弾道（trajectory）

打球角度の傾向を決める隠しパラメータ（1〜4）。パワーに連動して生成。

### 生成式
```
trajectoryBase = 1 + (power / 100) × 2.5 + (random - 0.5) × 1.5
trajectory = clamp(round(trajectoryBase), 1, 4)
```

### キャリーファクター（HR判定で使用）
| 弾道 | ファクター | 効果 |
|---|---|---|
| 1 | 1.07 | +7%（ゴロ打ちタイプ） |
| 2 | 1.19 | +19%（標準） |
| 3 | 1.25 | +25% |
| 4 | 1.30 | +30%（フライ打ちタイプ、最大飛距離） |

※急角度（35°以上）ではキャリー減衰が適用される

---

## 選手総合値（Overall）

### 野手総合値（1-999）
```
overall = contact × 2.2 + power × 2.2 + speed × 1.5 + eye × 1.5
        + fielding × 1.2 + arm × 0.8 + catching × 0.6
```

### 投手総合値（1-999）
```
velNorm = ((velocity - 120) / 45) × 100
pitchBonus = min(100, Σ(pitch.level × 12))
overall = velNorm × 2.0 + control × 2.5 + stamina × 1.5
        + mentalToughness × 1.0 + pitchBonus × 3.0
```

### ランク
| 値 | ランク |
|---|---|
| 900+ | S |
| 800-899 | A |
| 700-799 | B |
| 600-699 | C |
| 500-599 | D |
| 400-499 | E |
| 300-399 | F |
| &lt;300 | G |

---

## 12チーム一覧

### セントラル・リーグ
| ID | チーム名 | 略称 | カラー | 本拠地 |
|---|---|---|---|---|
| tokyo-eagles | 東京イーグルス | 東京 | 赤 | 東京ドーム |
| yokohama-stars | 横浜スターズ | 横浜 | 青 | 横浜スタジアム |
| nagoya-dragons | 名古屋ドラゴンズ | 名古屋 | 紺 | ナゴヤドーム |
| osaka-tigers | 大阪タイガース | 大阪 | 黄 | 甲子園球場 |
| hiroshima-reds | 広島レッズ | 広島 | 赤 | マツダスタジアム |
| sendai-swallows | 仙台スワローズ | 仙台 | 緑 | 仙台球場 |

### パシフィック・リーグ
| ID | チーム名 | 略称 | カラー | 本拠地 |
|---|---|---|---|---|
| fukuoka-hawks | 福岡ホークス | 福岡 | 琥珀 | 福岡PayPayドーム |
| sapporo-fighters | 札幌ファイターズ | 札幌 | 紺 | エスコンフィールド |
| chiba-marines | 千葉マリーンズ | 千葉 | 黒 | ZOZOマリンスタジアム |
| saitama-lions | 埼玉ライオンズ | 埼玉 | 青 | ベルーナドーム |
| kobe-buffaloes | 神戸バファローズ | 神戸 | 紫 | 京セラドーム |
| tohoku-golden | 東北ゴールデンズ | 東北 | 臙脂 | 楽天モバイルパーク |

---

## 未実装機能

| 機能 | 現状 |
|---|---|
| 途中交代（代打・代走・守備固め） | 未実装（GAME-001で実装予定） |
| サブポジション | 未実装（GAME-006で実装予定） |
| けが・故障 | 未実装（GAME-005で実装予定） |
